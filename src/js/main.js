var Reader,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Reader = (function() {
  var memStore, pagect, proxy;

  proxy = null;

  pagect = null;

  memStore = {
    html: {},
    body: {}
  };

  function Reader(options) {
    this.options = options != null ? options : {};
    this.initialize = bind(this.initialize, this);
    this.destroy = bind(this.destroy, this);
    proxy = document.createElement('div');
    proxy.id = "_" + (Date.now());
    this.utils = new this.Utils();
    this.query = new this.Query();
    this.parse = new this.Parse();
    this.layout = new this.Layout();
    this.template = new this.Template();
    this.events = new this.Events();
    this.wheel = new this.Wheel();
    this.swipe = new this.Swipe();
    this["package"] = {
      attributes: null,
      guide: null,
      manifest: null,
      metadata: null,
      spine: null,
      text: null
    };
    this.location = {
      assets: this.options.assets || '',
      url: ("" + window.location.origin).replace(/\/$/, '')
    };
    this.nav = {
      elem: null,
      regexp: null,
      path: null,
      attribute: null
    };
    this.navMap = null;
    this.ncx = null;
    this.html = [];
    this.metadata = [];
    this.navElem = document.getElementById('reader-nav');
    this.mainElem = document.getElementById('reader-frame');
  }

  Reader.prototype.getNavDocument = function(that) {
    return function(key, val, item) {
      if (key === that.nav.attribute && that.nav.regexp.test(val)) {
        that.nav.elem = item;
        that.nav.path = item.getAttribute('href');
        return that.xml();
      }
    };
  };

  Reader.prototype.renderPage = function(that) {
    return function(url, parentId, navId) {
      return that.query.html(that.location.assets + "/" + url).done(function(data) {
        var doc;
        doc = that.template.parse(data, that.location.assets);
        that.layout.render(doc, parentId, '#doc-nav');
        if (!(pagect -= 1)) {
          return that.trigger('pagesloaded', {});
        }
      });
    };
  };

  Reader.prototype.xml = function() {
    var curry;
    curry = this.renderPage(this);
    return this.query.xml(this.location.assets + "/" + this.nav.path).done((function(_this) {
      return function(data) {
        _this.ncx = _this.parse.nav(data);
        _this.navMap = _this.parse.mapNcx(_this.ncx.navMap.navPoint);
        return _this.layout.build(_this.navMap, curry, _this.mainElem.id);
      };
    })(this));
  };

  Reader.prototype.build = function(data) {
    var curry;
    curry = this.getNavDocument(this);
    return pagect = this.parse.xml(data, curry)["package"].spine.itemref.length;
  };

  Reader.prototype.on = function(method, callback) {
    var evt;
    evt = document.createEvent('CustomEvent');
    evt.initCustomEvent(method, true, false, {});
    return proxy.addEventListener(method, callback);
  };

  Reader.prototype.trigger = function(method, data) {
    return proxy.dispatchEvent(new CustomEvent(method, data));
  };

  Reader.prototype.setup = function() {
    memStore.html.overflow = $('html').css('overflow');
    memStore.body.overflow = $('body').css('overflow');
    $('html').addClass('reader');
    return $('html,body').css({
      overflow: 'hidden'
    });
  };

  Reader.prototype.destroy = function() {
    $('html').css({
      overflow: memStore.html.overflow
    }).removeClass('reader');
    $('body').css({
      overflow: memStore.body.overflow
    });
    this.events.destroy();
    this.swipe.destroy();
    return proxy = void 0;
  };

  Reader.prototype.initialize = function() {
    var attr, layoutcomplete, observer, token;
    token = this.options.toc ? 'nav' : 'ncx';
    attr = this.options.toc ? 'properties' : 'id';
    this.nav.regexp = new RegExp("^" + token + "$", 'i');
    this.nav.attribute = attr;
    this.setup();
    this.query.xml(this.options.packageUrl).done((function(_this) {
      return function(data) {
        return _this.build(data);
      };
    })(this));
    layoutcomplete = false;
    observer = new MutationObserver((function(_this) {
      return function(mutations) {
        return mutations.forEach(function(mutationRecord) {
          if (!layoutcomplete) {
            layoutcomplete = true;
            return _this.trigger('layoutcomplete', {});
          }
        });
      };
    })(this));
    observer.observe(document.body, {
      childList: true,
      attributes: true,
      attributeFilter: ['style']
    });
    this.on('pagesloaded', (function(_this) {
      return function() {
        console.log('Reader pagesloaded');
        return window.scopedPolyFill(document);
      };
    })(this));
    this.on('layoutcomplete', (function(_this) {
      return function() {
        console.log('Reader layoutcomplete');
        _this.events.initialize();
        return setTimeout((function() {
          return _this.trigger('ready', {});
        }), 0);
      };
    })(this));
    this.on('nextPage', (function(_this) {
      return function() {
        return _this.events.nextPage();
      };
    })(this));
    this.on('prevPage', (function(_this) {
      return function() {
        return _this.events.prevPage();
      };
    })(this));
    this.on('ready', (function(_this) {
      return function() {
        console.log('Reader ready');
        $(_this.mainElem).addClass('ready');
        _this.wheel.initialize();
        if (Modernizr.touch) {
          _this.swipe.initialize();
        }
        return $('a').each(function(i, el) {
          var $this;
          $this = $(el);
          if ($this.attr('href').match(/^#/)) {

          } else if ($this.attr('href').match(/^(?:\/|window.location.host)/)) {
            return $this.on('click', function() {
              return _this.destroy();
            });
          } else {
            return $this.attr('target', '_blank');
          }
        });
      };
    })(this));
    this.on('destroy', (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this));
    return window.onunload = window.onpopstate = (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this);
  };

  return Reader;

})();

window.Reader = Reader;

//# sourceMappingURL=data:application/json;base64,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TUFBTSxDQUFDLE1BQVAsR0FBZ0IiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIFJlYWRlclxuXG4gIHByb3h5ICAgID0gbnVsbFxuICBwYWdlY3QgICA9IG51bGxcbiAgbWVtU3RvcmUgPVxuICAgIGh0bWw6e31cbiAgICBib2R5Ont9XG5cbiAgY29uc3RydWN0b3I6IChAb3B0aW9ucyA9IHt9KS0+XG5cbiAgICAjIGNyZWF0ZSBhbiBlbGVtZW50IHRvIGF0dGFjaCBldmVudCBsaXN0ZW5lcnMgdG8uICBvbmx5IG5lZWRzIHRvIHN0YXkgaW5cbiAgICAjIG1lbW9yeSwgc28gbm90IGF0dGFjaGluZyBpdCB0byB0aGUgRE9NXG4gICAgI1xuICAgIHByb3h5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICBwcm94eS5pZCA9IFwiXyN7RGF0ZS5ub3coKX1cIjtcblxuICAgIEB1dGlscyAgICA9IG5ldyBAVXRpbHMoKVxuICAgIEBxdWVyeSAgICA9IG5ldyBAUXVlcnkoKVxuICAgIEBwYXJzZSAgICA9IG5ldyBAUGFyc2UoKVxuICAgIEBsYXlvdXQgICA9IG5ldyBATGF5b3V0KClcbiAgICBAdGVtcGxhdGUgPSBuZXcgQFRlbXBsYXRlKClcbiAgICBAZXZlbnRzICAgPSBuZXcgQEV2ZW50cygpXG4gICAgQHdoZWVsICAgID0gbmV3IEBXaGVlbCgpXG4gICAgQHN3aXBlICAgID0gbmV3IEBTd2lwZSgpXG5cbiAgICBAcGFja2FnZSA9XG4gICAgICBhdHRyaWJ1dGVzOiBudWxsXG4gICAgICBndWlkZSAgICAgOiBudWxsXG4gICAgICBtYW5pZmVzdCAgOiBudWxsXG4gICAgICBtZXRhZGF0YSAgOiBudWxsXG4gICAgICBzcGluZSAgICAgOiBudWxsXG4gICAgICB0ZXh0ICAgICAgOiBudWxsXG5cbiAgICBAbG9jYXRpb24gPVxuICAgICAgYXNzZXRzIDogQG9wdGlvbnMuYXNzZXRzIG9yICcnXG4gICAgICB1cmwgICAgOiBcIiN7d2luZG93LmxvY2F0aW9uLm9yaWdpbn1cIi5yZXBsYWNlKC9cXC8kLywgJycpXG5cbiAgICBAbmF2ID1cbiAgICAgIGVsZW0gICAgICA6IG51bGxcbiAgICAgIHJlZ2V4cCAgICA6IG51bGxcbiAgICAgIHBhdGggICAgICA6IG51bGxcbiAgICAgIGF0dHJpYnV0ZSA6IG51bGxcblxuICAgIEBuYXZNYXAgICA9IG51bGxcbiAgICBAbmN4ICAgICAgPSBudWxsXG4gICAgQGh0bWwgICAgID0gW11cbiAgICBAbWV0YWRhdGEgPSBbXVxuXG4gICAgQG5hdkVsZW0gID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlYWRlci1uYXYnKVxuICAgIEBtYWluRWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWFkZXItZnJhbWUnKVxuXG5cbiAgZ2V0TmF2RG9jdW1lbnQ6ICh0aGF0KS0+XG4gICAgcmV0dXJuIChrZXksIHZhbCwgaXRlbSktPlxuICAgICAgaWYga2V5ID09IHRoYXQubmF2LmF0dHJpYnV0ZSBhbmQgdGhhdC5uYXYucmVnZXhwLnRlc3QodmFsKVxuICAgICAgICB0aGF0Lm5hdi5lbGVtID0gaXRlbVxuICAgICAgICB0aGF0Lm5hdi5wYXRoID0gaXRlbS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKVxuICAgICAgICB0aGF0LnhtbCgpXG5cbiAgcmVuZGVyUGFnZTogKHRoYXQpLT5cbiAgICByZXR1cm4gKHVybCwgcGFyZW50SWQsIG5hdklkKSAtPlxuICAgICAgdGhhdC5xdWVyeS5odG1sKFwiI3t0aGF0LmxvY2F0aW9uLmFzc2V0c30vI3t1cmx9XCIpXG4gICAgICAgIC5kb25lIChkYXRhKS0+XG4gICAgICAgICAgZG9jID0gdGhhdC50ZW1wbGF0ZS5wYXJzZShkYXRhLCB0aGF0LmxvY2F0aW9uLmFzc2V0cylcbiAgICAgICAgICB0aGF0LmxheW91dC5yZW5kZXIoZG9jLCBwYXJlbnRJZCwgJyNkb2MtbmF2JylcbiAgICAgICAgICBpZiBub3QgcGFnZWN0IC09MSB0aGVuIHRoYXQudHJpZ2dlcigncGFnZXNsb2FkZWQnLCB7fSlcblxuICB4bWw6ICgpLT5cbiAgICBjdXJyeSA9IEByZW5kZXJQYWdlKEApXG4gICAgQHF1ZXJ5LnhtbChcIiN7QGxvY2F0aW9uLmFzc2V0c30vI3tAbmF2LnBhdGh9XCIpXG4gICAgICAuZG9uZSAoZGF0YSkgPT5cbiAgICAgICAgQG5jeCA9IEBwYXJzZS5uYXYoZGF0YSlcbiAgICAgICAgQG5hdk1hcCA9IEBwYXJzZS5tYXBOY3goQG5jeC5uYXZNYXAubmF2UG9pbnQpXG4gICAgICAgIEBsYXlvdXQuYnVpbGQoQG5hdk1hcCwgY3VycnksIEBtYWluRWxlbS5pZClcblxuICBidWlsZDogKGRhdGEpLT5cbiAgICBjdXJyeSA9IEBnZXROYXZEb2N1bWVudChAKVxuICAgIHBhZ2VjdCA9IEBwYXJzZS54bWwoZGF0YSwgY3VycnkpLnBhY2thZ2Uuc3BpbmUuaXRlbXJlZi5sZW5ndGhcblxuICBvbjogKG1ldGhvZCwgY2FsbGJhY2spIC0+XG4gICAgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0N1c3RvbUV2ZW50JylcbiAgICBldnQuaW5pdEN1c3RvbUV2ZW50KG1ldGhvZCwgdHJ1ZSwgZmFsc2UsIHt9KVxuICAgIHByb3h5LmFkZEV2ZW50TGlzdGVuZXIobWV0aG9kLCBjYWxsYmFjaylcblxuICB0cmlnZ2VyOiAobWV0aG9kLCBkYXRhKSAtPlxuICAgIHByb3h5LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KG1ldGhvZCwgZGF0YSkpXG5cbiAgc2V0dXA6KCktPlxuICAgICMgU3RvcmUgZXhpc3RpbmcgaHRtbC9ib2R5IGF0dHJpYnV0ZXMgYW5kIGFwcGx5IHJlYWRlciBhdHRyaWJ1dGVzXG4gICAgI1xuICAgIG1lbVN0b3JlLmh0bWwub3ZlcmZsb3cgPSAkKCdodG1sJykuY3NzKCdvdmVyZmxvdycpXG4gICAgbWVtU3RvcmUuYm9keS5vdmVyZmxvdyA9ICQoJ2JvZHknKS5jc3MoJ292ZXJmbG93JylcbiAgICAkKCdodG1sJykuYWRkQ2xhc3MoJ3JlYWRlcicpXG4gICAgJCgnaHRtbCxib2R5JykuY3NzKHtvdmVyZmxvdzonaGlkZGVuJ30pXG5cbiAgZGVzdHJveTooKT0+XG4gICAgIyBSZXNldCBwcmV2aW91cyBhdHRyaWJ1dGVzIG9uIGh0bWwvYm9keSwgYW5kIHJlbW92ZSBwcm94eSBlbGVtZW50XG4gICAgI1xuICAgICQoJ2h0bWwnKS5jc3Moe292ZXJmbG93Om1lbVN0b3JlLmh0bWwub3ZlcmZsb3d9KS5yZW1vdmVDbGFzcygncmVhZGVyJylcbiAgICAkKCdib2R5JykuY3NzKHtvdmVyZmxvdzptZW1TdG9yZS5ib2R5Lm92ZXJmbG93fSlcbiAgICBAZXZlbnRzLmRlc3Ryb3koKVxuICAgIEBzd2lwZS5kZXN0cm95KClcbiAgICBwcm94eSA9IHVuZGVmaW5lZFxuXG4gIGluaXRpYWxpemU6ID0+XG4gICAgdG9rZW4gPSBpZiBAb3B0aW9ucy50b2MgdGhlbiAnbmF2JyBlbHNlICduY3gnXG4gICAgYXR0ciA9IGlmIEBvcHRpb25zLnRvYyB0aGVuICdwcm9wZXJ0aWVzJyBlbHNlICdpZCdcbiAgICBAbmF2LnJlZ2V4cCA9IG5ldyBSZWdFeHAoXCJeI3t0b2tlbn0kXCIsICdpJylcbiAgICBAbmF2LmF0dHJpYnV0ZSA9IGF0dHJcbiAgICBAc2V0dXAoKVxuICAgIEBxdWVyeS54bWwoQG9wdGlvbnMucGFja2FnZVVybCkuZG9uZSAoZGF0YSkgPT4gQGJ1aWxkKGRhdGEpXG5cbiAgICBsYXlvdXRjb21wbGV0ZSA9IGZhbHNlXG4gICAgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zKSA9PlxuICAgICAgbXV0YXRpb25zLmZvckVhY2ggKG11dGF0aW9uUmVjb3JkKSA9PlxuICAgICAgICBpZiAhbGF5b3V0Y29tcGxldGVcbiAgICAgICAgICBsYXlvdXRjb21wbGV0ZSA9IHRydWVcbiAgICAgICAgICBAdHJpZ2dlcignbGF5b3V0Y29tcGxldGUnLCB7fSlcbiAgICApXG5cbiAgICBvYnNlcnZlci5vYnNlcnZlIGRvY3VtZW50LmJvZHksXG4gICAgICBjaGlsZExpc3Q6IHRydWVcbiAgICAgIGF0dHJpYnV0ZXM6IHRydWVcbiAgICAgIGF0dHJpYnV0ZUZpbHRlcjogWydzdHlsZSddXG5cbiAgICAjIFB1YmxpYyBldmVudCBsaXN0ZW5lcnNcbiAgICAjXG4gICAgQG9uICdwYWdlc2xvYWRlZCcsID0+XG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIHBhZ2VzbG9hZGVkJ1xuICAgICAgd2luZG93LnNjb3BlZFBvbHlGaWxsKGRvY3VtZW50KVxuXG4gICAgQG9uICdsYXlvdXRjb21wbGV0ZScsID0+XG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIGxheW91dGNvbXBsZXRlJ1xuICAgICAgQGV2ZW50cy5pbml0aWFsaXplKClcbiAgICAgIHNldFRpbWVvdXQgKCgpID0+IEB0cmlnZ2VyKCdyZWFkeScsIHt9KSApLCAwXG5cblxuICAgIEBvbiAnbmV4dFBhZ2UnLCA9PiBAZXZlbnRzLm5leHRQYWdlKClcbiAgICBAb24gJ3ByZXZQYWdlJywgPT4gQGV2ZW50cy5wcmV2UGFnZSgpXG5cbiAgICBAb24gJ3JlYWR5JywgPT5cbiAgICAgIGNvbnNvbGUubG9nICdSZWFkZXIgcmVhZHknXG4gICAgICAkKEBtYWluRWxlbSkuYWRkQ2xhc3MoJ3JlYWR5JylcblxuICAgICAgIyBpbml0IHdoZWVsIGV2ZW50IGhhbmRsaW5nXG4gICAgICAjXG4gICAgICBAd2hlZWwuaW5pdGlhbGl6ZSgpXG5cbiAgICAgICMgaW5pdCB0b3VjaCBldmVudCBoYW5kbGluZ1xuICAgICAgI1xuICAgICAgaWYgTW9kZXJuaXpyLnRvdWNoIHRoZW4gQHN3aXBlLmluaXRpYWxpemUoKVxuXG4gICAgICAjIHNvbWUgRE9NIG1hbmlwdWxhdGlvbiBmb3IgbGluayBiZWhhdmlvdXJcbiAgICAgICNcbiAgICAgICQoJ2EnKS5lYWNoIChpLCBlbCk9PlxuICAgICAgICAkdGhpcyA9ICQoZWwpXG4gICAgICAgIGlmICR0aGlzLmF0dHIoJ2hyZWYnKS5tYXRjaCgvXiMvKVxuICAgICAgICAgIHJldHVyblxuICAgICAgICBlbHNlIGlmICR0aGlzLmF0dHIoJ2hyZWYnKS5tYXRjaCgvXig/OlxcL3x3aW5kb3cubG9jYXRpb24uaG9zdCkvKVxuICAgICAgICAgICR0aGlzLm9uICdjbGljaycsID0+IEBkZXN0cm95KClcbiAgICAgICAgZWxzZVxuICAgICAgICAgICR0aGlzLmF0dHIoJ3RhcmdldCcsICdfYmxhbmsnKVxuXG4gICAgQG9uICdkZXN0cm95JywgPT5cbiAgICAgIEBkZXN0cm95KClcblxuICAgICMgSW1wb3J0YW50IHRvIGRlc3Ryb3kgb3VyIHByb3h5IGVsZW1lbnQsIGFzIGl0IHdpbGwgY29udGludWUgdG8gaGF2ZVxuICAgICMgaGFuZGxlcnMgYXR0YWNoZWQgdW5sZXNzIGl0J3MgcmVtb3ZlZFxuICAgICNcbiAgICB3aW5kb3cub251bmxvYWQgPSB3aW5kb3cub25wb3BzdGF0ZSA9ICgpID0+IEBkZXN0cm95KClcblxuXG53aW5kb3cuUmVhZGVyID0gUmVhZGVyXG4iXX0=

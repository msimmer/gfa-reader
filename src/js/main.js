var Reader,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Reader = (function() {
  var memStore, pagect, proxy;

  proxy = null;

  pagect = null;

  memStore = {
    html: {},
    body: {}
  };

  function Reader(options) {
    this.options = options != null ? options : {};
    this.initialize = bind(this.initialize, this);
    this.destroy = bind(this.destroy, this);
    $('.wrapper').css('visibility', 'hidden');
    NProgress.configure({
      showSpinner: false,
      minimum: 0.1,
      speed: 250
    });
    NProgress.start();
    NProgress.set(0.3);
    proxy = document.createElement('div');
    proxy.id = "_" + (Date.now());
    this.utils = new this.Utils();
    this.query = new this.Query();
    this.parse = new this.Parse();
    this.layout = new this.Layout();
    this.template = new this.Template();
    this.events = new this.Events();
    this.wheel = new this.Wheel();
    this.swipe = new this.Swipe();
    this["package"] = {
      attributes: null,
      guide: null,
      manifest: null,
      metadata: null,
      spine: null,
      text: null
    };
    this.location = {
      assets: this.options.assets || '',
      url: ("" + window.location.origin).replace(/\/$/, '')
    };
    this.nav = {
      elem: null,
      regexp: null,
      path: null,
      attribute: null
    };
    this.navMap = null;
    this.ncx = null;
    this.html = [];
    this.metadata = [];
    this.navElem = document.getElementById('reader-nav');
    this.mainElem = document.getElementById('reader-frame');
  }

  Reader.prototype.getNavDocument = function(that) {
    return function(key, val, item) {
      if (key === that.nav.attribute && that.nav.regexp.test(val)) {
        that.nav.elem = item;
        that.nav.path = item.getAttribute('href');
        return that.xml();
      }
    };
  };

  Reader.prototype.renderPage = function(that) {
    return function(url, parentId, navId) {
      return that.query.html(that.location.assets + "/" + url).done(function(data) {
        var doc;
        doc = that.template.parse(data, that.location.assets);
        that.layout.render(doc, parentId, '#doc-nav');
        if (!(pagect -= 1)) {
          return that.trigger('pagesloaded', {});
        }
      });
    };
  };

  Reader.prototype.xml = function() {
    var curry;
    curry = this.renderPage(this);
    return this.query.xml(this.location.assets + "/" + this.nav.path).done((function(_this) {
      return function(data) {
        _this.ncx = _this.parse.nav(data);
        _this.navMap = _this.parse.mapNcx(_this.ncx.navMap.navPoint);
        return _this.layout.build(_this.navMap, curry, _this.mainElem.id);
      };
    })(this));
  };

  Reader.prototype.build = function(data) {
    var curry;
    curry = this.getNavDocument(this);
    return pagect = this.parse.xml(data, curry)["package"].spine.itemref.length;
  };

  Reader.prototype.on = function(method, callback) {
    var evt;
    evt = document.createEvent('CustomEvent');
    evt.initCustomEvent(method, true, false, {});
    return proxy.addEventListener(method, callback);
  };

  Reader.prototype.trigger = function(method, data) {
    return proxy.dispatchEvent(new CustomEvent(method, data));
  };

  Reader.prototype.setup = function() {
    memStore.html.overflow = $('html').css('overflow');
    memStore.body.overflow = $('body').css('overflow');
    $('html').addClass('reader');
    return $('html,body').css({
      overflow: 'hidden'
    });
  };

  Reader.prototype.destroy = function() {
    $('html').css({
      overflow: memStore.html.overflow
    }).removeClass('reader');
    $('body').css({
      overflow: memStore.body.overflow
    });
    this.events.destroy();
    this.swipe.destroy();
    return proxy = void 0;
  };

  Reader.prototype.initialize = function() {
    var attr, layoutcomplete, observer, token;
    NProgress.set(0.5);
    token = this.options.toc ? 'nav' : 'ncx';
    attr = this.options.toc ? 'properties' : 'id';
    this.nav.regexp = new RegExp("^" + token + "$", 'i');
    this.nav.attribute = attr;
    this.setup();
    this.query.xml(this.options.packageUrl).done((function(_this) {
      return function(data) {
        return _this.build(data);
      };
    })(this));
    layoutcomplete = false;
    observer = new MutationObserver((function(_this) {
      return function(mutations) {
        return mutations.forEach(function(mutationRecord) {
          if (!layoutcomplete) {
            layoutcomplete = true;
            return _this.trigger('layoutcomplete', {});
          }
        });
      };
    })(this));
    observer.observe(document.body, {
      childList: true,
      attributes: true,
      attributeFilter: ['style']
    });
    this.on('pagesloaded', (function(_this) {
      return function() {
        NProgress.set(0.7);
        console.log('Reader pagesloaded');
        return window.scopedPolyFill(document);
      };
    })(this));
    this.on('layoutcomplete', (function(_this) {
      return function() {
        NProgress.set(0.9);
        console.log('Reader layoutcomplete');
        _this.events.initialize();
        return setTimeout((function() {
          return _this.trigger('ready', {});
        }), 0);
      };
    })(this));
    this.on('nextPage', (function(_this) {
      return function() {
        return _this.events.nextPage();
      };
    })(this));
    this.on('prevPage', (function(_this) {
      return function() {
        return _this.events.prevPage();
      };
    })(this));
    this.on('ready', (function(_this) {
      return function() {
        NProgress.done();
        console.log('Reader ready');
        $('.wrapper').css('visibility', 'visible');
        $(_this.mainElem).addClass('ready');
        _this.wheel.initialize();
        if (Modernizr.touch) {
          _this.swipe.initialize();
        }
        return $('a').each(function(i, el) {
          var $this;
          $this = $(el);
          if ($this.attr('href').match(/^#/)) {

          } else if ($this.attr('href').match(/^(?:\/|window.location.host)/)) {
            return $this.on('click', function() {
              return _this.destroy();
            });
          } else {
            return $this.attr('target', '_blank');
          }
        });
      };
    })(this));
    this.on('destroy', (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this));
    return window.onunload = window.onpopstate = (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this);
  };

  return Reader;

})();

window.Reader = Reader;

//# sourceMappingURL=data:application/json;base64,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bEIsRUFERztXQUFBLE1BQUE7bUJBR0gsS0FBSyxDQUFDLElBQU4sQ0FBVyxRQUFYLEVBQXFCLFFBQXJCLEVBSEc7O1FBSkssQ0FBWjtNQW5CVztJQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBYjtJQTRCQSxJQUFDLENBQUEsRUFBRCxDQUFJLFNBQUosRUFBZSxDQUFBLFNBQUEsS0FBQTthQUFBLFNBQUE7ZUFDYixLQUFDLENBQUEsT0FBRCxDQUFBO01BRGE7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQWY7V0FNQSxNQUFNLENBQUMsUUFBUCxHQUFrQixNQUFNLENBQUMsVUFBUCxHQUFvQixDQUFBLFNBQUEsS0FBQTthQUFBLFNBQUE7ZUFBTSxLQUFDLENBQUEsT0FBRCxDQUFBO01BQU47SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBO0VBL0U1Qjs7Ozs7O0FBa0ZkLE1BQU0sQ0FBQyxNQUFQLEdBQWdCIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBSZWFkZXJcblxuICBwcm94eSAgICA9IG51bGxcbiAgcGFnZWN0ICAgPSBudWxsXG4gIG1lbVN0b3JlID1cbiAgICBodG1sOnt9XG4gICAgYm9keTp7fVxuXG4gIGNvbnN0cnVjdG9yOiAoQG9wdGlvbnMgPSB7fSktPlxuXG4gICAgIyBLaWNrIG9mZiBvdXIgcHJvZ3Jlc3MgYmFyXG4gICAgI1xuICAgICQoJy53cmFwcGVyJykuY3NzKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpXG4gICAgTlByb2dyZXNzLmNvbmZpZ3VyZVxuICAgICAgc2hvd1NwaW5uZXI6IGZhbHNlXG4gICAgICBtaW5pbXVtOiAwLjFcbiAgICAgIHNwZWVkOiAyNTBcbiAgICBOUHJvZ3Jlc3Muc3RhcnQoKVxuICAgIE5Qcm9ncmVzcy5zZXQoMC4zKVxuXG4gICAgIyBjcmVhdGUgYW4gZWxlbWVudCB0byBhdHRhY2ggZXZlbnQgbGlzdGVuZXJzIHRvLiAgb25seSBuZWVkcyB0byBzdGF5IGluXG4gICAgIyBtZW1vcnksIHNvIG5vdCBhdHRhY2hpbmcgaXQgdG8gdGhlIERPTVxuICAgICNcbiAgICBwcm94eSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgcHJveHkuaWQgPSBcIl8je0RhdGUubm93KCl9XCI7XG5cbiAgICBAdXRpbHMgICAgPSBuZXcgQFV0aWxzKClcbiAgICBAcXVlcnkgICAgPSBuZXcgQFF1ZXJ5KClcbiAgICBAcGFyc2UgICAgPSBuZXcgQFBhcnNlKClcbiAgICBAbGF5b3V0ICAgPSBuZXcgQExheW91dCgpXG4gICAgQHRlbXBsYXRlID0gbmV3IEBUZW1wbGF0ZSgpXG4gICAgQGV2ZW50cyAgID0gbmV3IEBFdmVudHMoKVxuICAgIEB3aGVlbCAgICA9IG5ldyBAV2hlZWwoKVxuICAgIEBzd2lwZSAgICA9IG5ldyBAU3dpcGUoKVxuXG4gICAgQHBhY2thZ2UgPVxuICAgICAgYXR0cmlidXRlczogbnVsbFxuICAgICAgZ3VpZGUgICAgIDogbnVsbFxuICAgICAgbWFuaWZlc3QgIDogbnVsbFxuICAgICAgbWV0YWRhdGEgIDogbnVsbFxuICAgICAgc3BpbmUgICAgIDogbnVsbFxuICAgICAgdGV4dCAgICAgIDogbnVsbFxuXG4gICAgQGxvY2F0aW9uID1cbiAgICAgIGFzc2V0cyA6IEBvcHRpb25zLmFzc2V0cyBvciAnJ1xuICAgICAgdXJsICAgIDogXCIje3dpbmRvdy5sb2NhdGlvbi5vcmlnaW59XCIucmVwbGFjZSgvXFwvJC8sICcnKVxuXG4gICAgQG5hdiA9XG4gICAgICBlbGVtICAgICAgOiBudWxsXG4gICAgICByZWdleHAgICAgOiBudWxsXG4gICAgICBwYXRoICAgICAgOiBudWxsXG4gICAgICBhdHRyaWJ1dGUgOiBudWxsXG5cbiAgICBAbmF2TWFwICAgPSBudWxsXG4gICAgQG5jeCAgICAgID0gbnVsbFxuICAgIEBodG1sICAgICA9IFtdXG4gICAgQG1ldGFkYXRhID0gW11cblxuICAgIEBuYXZFbGVtICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWFkZXItbmF2JylcbiAgICBAbWFpbkVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVhZGVyLWZyYW1lJylcblxuICAgICMgJChAbWFpbkVsZW0pLmNzcyhvcGFjaXR5OjApXG5cblxuICBnZXROYXZEb2N1bWVudDogKHRoYXQpLT5cbiAgICByZXR1cm4gKGtleSwgdmFsLCBpdGVtKS0+XG4gICAgICBpZiBrZXkgPT0gdGhhdC5uYXYuYXR0cmlidXRlIGFuZCB0aGF0Lm5hdi5yZWdleHAudGVzdCh2YWwpXG4gICAgICAgIHRoYXQubmF2LmVsZW0gPSBpdGVtXG4gICAgICAgIHRoYXQubmF2LnBhdGggPSBpdGVtLmdldEF0dHJpYnV0ZSgnaHJlZicpXG4gICAgICAgIHRoYXQueG1sKClcblxuICByZW5kZXJQYWdlOiAodGhhdCktPlxuICAgIHJldHVybiAodXJsLCBwYXJlbnRJZCwgbmF2SWQpIC0+XG4gICAgICB0aGF0LnF1ZXJ5Lmh0bWwoXCIje3RoYXQubG9jYXRpb24uYXNzZXRzfS8je3VybH1cIilcbiAgICAgICAgLmRvbmUgKGRhdGEpLT5cbiAgICAgICAgICBkb2MgPSB0aGF0LnRlbXBsYXRlLnBhcnNlKGRhdGEsIHRoYXQubG9jYXRpb24uYXNzZXRzKVxuICAgICAgICAgIHRoYXQubGF5b3V0LnJlbmRlcihkb2MsIHBhcmVudElkLCAnI2RvYy1uYXYnKVxuICAgICAgICAgIGlmIG5vdCBwYWdlY3QgLT0xIHRoZW4gdGhhdC50cmlnZ2VyKCdwYWdlc2xvYWRlZCcsIHt9KVxuXG4gIHhtbDogKCktPlxuICAgIGN1cnJ5ID0gQHJlbmRlclBhZ2UoQClcbiAgICBAcXVlcnkueG1sKFwiI3tAbG9jYXRpb24uYXNzZXRzfS8je0BuYXYucGF0aH1cIilcbiAgICAgIC5kb25lIChkYXRhKSA9PlxuICAgICAgICBAbmN4ID0gQHBhcnNlLm5hdihkYXRhKVxuICAgICAgICBAbmF2TWFwID0gQHBhcnNlLm1hcE5jeChAbmN4Lm5hdk1hcC5uYXZQb2ludClcbiAgICAgICAgQGxheW91dC5idWlsZChAbmF2TWFwLCBjdXJyeSwgQG1haW5FbGVtLmlkKVxuXG4gIGJ1aWxkOiAoZGF0YSktPlxuICAgIGN1cnJ5ID0gQGdldE5hdkRvY3VtZW50KEApXG4gICAgcGFnZWN0ID0gQHBhcnNlLnhtbChkYXRhLCBjdXJyeSkucGFja2FnZS5zcGluZS5pdGVtcmVmLmxlbmd0aFxuXG4gIG9uOiAobWV0aG9kLCBjYWxsYmFjaykgLT5cbiAgICBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnQ3VzdG9tRXZlbnQnKVxuICAgIGV2dC5pbml0Q3VzdG9tRXZlbnQobWV0aG9kLCB0cnVlLCBmYWxzZSwge30pXG4gICAgcHJveHkuYWRkRXZlbnRMaXN0ZW5lcihtZXRob2QsIGNhbGxiYWNrKVxuXG4gIHRyaWdnZXI6IChtZXRob2QsIGRhdGEpIC0+XG4gICAgcHJveHkuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQobWV0aG9kLCBkYXRhKSlcblxuICBzZXR1cDooKS0+XG4gICAgIyBTdG9yZSBleGlzdGluZyBodG1sL2JvZHkgYXR0cmlidXRlcyBhbmQgYXBwbHkgcmVhZGVyIGF0dHJpYnV0ZXNcbiAgICAjXG4gICAgbWVtU3RvcmUuaHRtbC5vdmVyZmxvdyA9ICQoJ2h0bWwnKS5jc3MoJ292ZXJmbG93JylcbiAgICBtZW1TdG9yZS5ib2R5Lm92ZXJmbG93ID0gJCgnYm9keScpLmNzcygnb3ZlcmZsb3cnKVxuICAgICQoJ2h0bWwnKS5hZGRDbGFzcygncmVhZGVyJylcbiAgICAkKCdodG1sLGJvZHknKS5jc3Moe292ZXJmbG93OidoaWRkZW4nfSlcblxuICBkZXN0cm95OigpPT5cbiAgICAjIFJlc2V0IHByZXZpb3VzIGF0dHJpYnV0ZXMgb24gaHRtbC9ib2R5LCBhbmQgcmVtb3ZlIHByb3h5IGVsZW1lbnRcbiAgICAjXG4gICAgJCgnaHRtbCcpLmNzcyh7b3ZlcmZsb3c6bWVtU3RvcmUuaHRtbC5vdmVyZmxvd30pLnJlbW92ZUNsYXNzKCdyZWFkZXInKVxuICAgICQoJ2JvZHknKS5jc3Moe292ZXJmbG93Om1lbVN0b3JlLmJvZHkub3ZlcmZsb3d9KVxuICAgIEBldmVudHMuZGVzdHJveSgpXG4gICAgQHN3aXBlLmRlc3Ryb3koKVxuICAgIHByb3h5ID0gdW5kZWZpbmVkXG5cbiAgaW5pdGlhbGl6ZTogPT5cblxuICAgIE5Qcm9ncmVzcy5zZXQoMC41KVxuXG4gICAgdG9rZW4gPSBpZiBAb3B0aW9ucy50b2MgdGhlbiAnbmF2JyBlbHNlICduY3gnXG4gICAgYXR0ciA9IGlmIEBvcHRpb25zLnRvYyB0aGVuICdwcm9wZXJ0aWVzJyBlbHNlICdpZCdcbiAgICBAbmF2LnJlZ2V4cCA9IG5ldyBSZWdFeHAoXCJeI3t0b2tlbn0kXCIsICdpJylcbiAgICBAbmF2LmF0dHJpYnV0ZSA9IGF0dHJcbiAgICBAc2V0dXAoKVxuICAgIEBxdWVyeS54bWwoQG9wdGlvbnMucGFja2FnZVVybCkuZG9uZSAoZGF0YSkgPT4gQGJ1aWxkKGRhdGEpXG5cbiAgICBsYXlvdXRjb21wbGV0ZSA9IGZhbHNlXG4gICAgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zKSA9PlxuICAgICAgbXV0YXRpb25zLmZvckVhY2ggKG11dGF0aW9uUmVjb3JkKSA9PlxuICAgICAgICBpZiAhbGF5b3V0Y29tcGxldGVcbiAgICAgICAgICBsYXlvdXRjb21wbGV0ZSA9IHRydWVcbiAgICAgICAgICBAdHJpZ2dlcignbGF5b3V0Y29tcGxldGUnLCB7fSlcbiAgICApXG5cbiAgICBvYnNlcnZlci5vYnNlcnZlIGRvY3VtZW50LmJvZHksXG4gICAgICBjaGlsZExpc3Q6IHRydWVcbiAgICAgIGF0dHJpYnV0ZXM6IHRydWVcbiAgICAgIGF0dHJpYnV0ZUZpbHRlcjogWydzdHlsZSddXG5cbiAgICAjIFB1YmxpYyBldmVudCBsaXN0ZW5lcnNcbiAgICAjXG4gICAgQG9uICdwYWdlc2xvYWRlZCcsID0+XG5cbiAgICAgIE5Qcm9ncmVzcy5zZXQoMC43KVxuXG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIHBhZ2VzbG9hZGVkJ1xuICAgICAgd2luZG93LnNjb3BlZFBvbHlGaWxsKGRvY3VtZW50KVxuXG4gICAgQG9uICdsYXlvdXRjb21wbGV0ZScsID0+XG5cbiAgICAgIE5Qcm9ncmVzcy5zZXQoMC45KVxuXG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIGxheW91dGNvbXBsZXRlJ1xuICAgICAgQGV2ZW50cy5pbml0aWFsaXplKClcbiAgICAgIHNldFRpbWVvdXQgKCgpID0+IEB0cmlnZ2VyKCdyZWFkeScsIHt9KSApLCAwXG5cblxuICAgIEBvbiAnbmV4dFBhZ2UnLCA9PiBAZXZlbnRzLm5leHRQYWdlKClcbiAgICBAb24gJ3ByZXZQYWdlJywgPT4gQGV2ZW50cy5wcmV2UGFnZSgpXG5cbiAgICBAb24gJ3JlYWR5JywgPT5cblxuICAgICAgTlByb2dyZXNzLmRvbmUoKVxuXG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIHJlYWR5J1xuICAgICAgJCgnLndyYXBwZXInKS5jc3MoJ3Zpc2liaWxpdHknLCAndmlzaWJsZScpXG4gICAgICAkKEBtYWluRWxlbSkuYWRkQ2xhc3MoJ3JlYWR5JylcbiAgICAgICMgJChAbWFpbkVsZW0pLmNzcyhvcGFjaXR5OjEpXG5cbiAgICAgICMgaW5pdCB3aGVlbCBldmVudCBoYW5kbGluZ1xuICAgICAgI1xuICAgICAgQHdoZWVsLmluaXRpYWxpemUoKVxuXG4gICAgICAjIGluaXQgdG91Y2ggZXZlbnQgaGFuZGxpbmdcbiAgICAgICNcbiAgICAgIGlmIE1vZGVybml6ci50b3VjaCB0aGVuIEBzd2lwZS5pbml0aWFsaXplKClcblxuICAgICAgIyBzb21lIERPTSBtYW5pcHVsYXRpb24gZm9yIGxpbmsgYmVoYXZpb3VyXG4gICAgICAjXG4gICAgICAkKCdhJykuZWFjaCAoaSwgZWwpPT5cbiAgICAgICAgJHRoaXMgPSAkKGVsKVxuICAgICAgICBpZiAkdGhpcy5hdHRyKCdocmVmJykubWF0Y2goL14jLylcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgZWxzZSBpZiAkdGhpcy5hdHRyKCdocmVmJykubWF0Y2goL14oPzpcXC98d2luZG93LmxvY2F0aW9uLmhvc3QpLylcbiAgICAgICAgICAkdGhpcy5vbiAnY2xpY2snLCA9PiBAZGVzdHJveSgpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAkdGhpcy5hdHRyKCd0YXJnZXQnLCAnX2JsYW5rJylcblxuICAgIEBvbiAnZGVzdHJveScsID0+XG4gICAgICBAZGVzdHJveSgpXG5cbiAgICAjIEltcG9ydGFudCB0byBkZXN0cm95IG91ciBwcm94eSBlbGVtZW50LCBhcyBpdCB3aWxsIGNvbnRpbnVlIHRvIGhhdmVcbiAgICAjIGhhbmRsZXJzIGF0dGFjaGVkIHVubGVzcyBpdCdzIHJlbW92ZWRcbiAgICAjXG4gICAgd2luZG93Lm9udW5sb2FkID0gd2luZG93Lm9ucG9wc3RhdGUgPSAoKSA9PiBAZGVzdHJveSgpXG5cblxud2luZG93LlJlYWRlciA9IFJlYWRlclxuIl19

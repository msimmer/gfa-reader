var Reader,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Reader = (function() {
  var memStore, pagect, proxy;

  proxy = null;

  pagect = null;

  memStore = {
    html: {},
    body: {}
  };

  function Reader(options) {
    this.options = options != null ? options : {};
    this.initialize = bind(this.initialize, this);
    this.destroy = bind(this.destroy, this);
    proxy = document.createElement('div');
    proxy.id = "_" + (Date.now());
    this.utils = new this.Utils();
    this.query = new this.Query();
    this.parse = new this.Parse();
    this.layout = new this.Layout();
    this.template = new this.Template();
    this.events = new this.Events();
    this.swipe = new this.Swipe();
    this["package"] = {
      attributes: null,
      guide: null,
      manifest: null,
      metadata: null,
      spine: null,
      text: null
    };
    this.location = {
      assets: this.options.assets || '',
      url: ("" + window.location.origin).replace(/\/$/, '')
    };
    this.nav = {
      elem: null,
      regexp: null,
      path: null,
      attribute: null
    };
    this.navMap = null;
    this.ncx = null;
    this.html = [];
    this.metadata = [];
    this.navElem = document.getElementById('reader-nav');
    this.mainElem = document.getElementById('reader-frame');
  }

  Reader.prototype.getNavDocument = function(that) {
    return function(key, val, item) {
      if (key === that.nav.attribute && that.nav.regexp.test(val)) {
        that.nav.elem = item;
        that.nav.path = item.getAttribute('href');
        return that.xml();
      }
    };
  };

  Reader.prototype.renderPage = function(that) {
    return function(url, parentId, navId) {
      return that.query.html(that.location.assets + "/" + url).done(function(data) {
        var doc;
        doc = that.template.parse(data, that.location.assets);
        that.layout.render(doc, parentId, '#doc-nav');
        if (!(pagect -= 1)) {
          return that.trigger('pagesloaded', {});
        }
      });
    };
  };

  Reader.prototype.xml = function() {
    var curry;
    curry = this.renderPage(this);
    return this.query.xml(this.location.assets + "/" + this.nav.path).done((function(_this) {
      return function(data) {
        _this.ncx = _this.parse.nav(data);
        _this.navMap = _this.parse.mapNcx(_this.ncx.navMap.navPoint);
        return _this.layout.build(_this.navMap, curry, _this.mainElem.id);
      };
    })(this));
  };

  Reader.prototype.build = function(data) {
    var curry;
    curry = this.getNavDocument(this);
    return pagect = this.parse.xml(data, curry)["package"].spine.itemref.length;
  };

  Reader.prototype.on = function(method, callback) {
    var evt;
    evt = document.createEvent('CustomEvent');
    evt.initCustomEvent(method, true, false, {});
    return proxy.addEventListener(method, callback);
  };

  Reader.prototype.trigger = function(method, data) {
    return proxy.dispatchEvent(new CustomEvent(method, data));
  };

  Reader.prototype.setup = function() {
    memStore.html.overflow = $('html').css('overflow');
    memStore.body.overflow = $('body').css('overflow');
    $('html').addClass('reader');
    return $('html,body').css({
      overflow: 'hidden'
    });
  };

  Reader.prototype.destroy = function() {
    $('html').css({
      overflow: memStore.html.overflow
    }).removeClass('reader');
    $('body').css({
      overflow: memStore.body.overflow
    });
    this.events.destroy();
    return proxy = void 0;
  };

  Reader.prototype.initialize = function() {
    var attr, layoutcomplete, observer, token;
    token = this.options.toc ? 'nav' : 'ncx';
    attr = this.options.toc ? 'properties' : 'id';
    this.nav.regexp = new RegExp("^" + token + "$", 'i');
    this.nav.attribute = attr;
    this.setup();
    this.query.xml(this.options.packageUrl).done((function(_this) {
      return function(data) {
        return _this.build(data);
      };
    })(this));
    layoutcomplete = false;
    observer = new MutationObserver((function(_this) {
      return function(mutations) {
        return mutations.forEach(function(mutationRecord) {
          if (!layoutcomplete) {
            layoutcomplete = true;
            return _this.trigger('layoutcomplete', {});
          }
        });
      };
    })(this));
    observer.observe(document.body, {
      childList: true,
      attributes: true,
      attributeFilter: ['style']
    });
    this.on('pagesloaded', (function(_this) {
      return function() {
        console.log('Reader pagesloaded');
        return window.scopedPolyFill(document);
      };
    })(this));
    this.on('layoutcomplete', (function(_this) {
      return function() {
        console.log('Reader layoutcomplete');
        _this.events.initialize();
        return setTimeout((function() {
          return _this.trigger('ready', {});
        }), 0);
      };
    })(this));
    this.on('nextPage', (function(_this) {
      return function() {
        return _this.events.nextPage();
      };
    })(this));
    this.on('prevPage', (function(_this) {
      return function() {
        return _this.events.prevPage();
      };
    })(this));
    this.on('ready', (function(_this) {
      return function() {
        console.log('Reader ready');
        $(_this.mainElem).addClass('ready');
        _this.swipe.initialize();
        return $('a').each(function(i, el) {
          var $this;
          $this = $(el);
          if ($this.attr('href').match(/^#/)) {

          } else if ($this.attr('href').match(/^(?:\/|window.location.host)/)) {
            return $this.on('click', function() {
              return _this.destroy();
            });
          } else {
            return $this.attr('target', '_blank');
          }
        });
      };
    })(this));
    this.on('destroy', (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this));
    return window.onunload = window.onpopstate = (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this);
  };

  return Reader;

})();

window.Reader = Reader;

//# sourceMappingURL=data:application/json;base64,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LE9BQXRCO1FBSUEsS0FBQyxDQUFBLEtBQUssQ0FBQyxVQUFQLENBQUE7ZUFJQSxDQUFBLENBQUUsR0FBRixDQUFNLENBQUMsSUFBUCxDQUFZLFNBQUMsQ0FBRCxFQUFJLEVBQUo7QUFDVixjQUFBO1VBQUEsS0FBQSxHQUFRLENBQUEsQ0FBRSxFQUFGO1VBQ1IsSUFBRyxLQUFLLENBQUMsSUFBTixDQUFXLE1BQVgsQ0FBa0IsQ0FBQyxLQUFuQixDQUF5QixJQUF6QixDQUFIO0FBQUE7V0FBQSxNQUVLLElBQUcsS0FBSyxDQUFDLElBQU4sQ0FBVyxNQUFYLENBQWtCLENBQUMsS0FBbkIsQ0FBeUIsOEJBQXpCLENBQUg7bUJBQ0gsS0FBSyxDQUFDLEVBQU4sQ0FBUyxPQUFULEVBQWtCLFNBQUE7cUJBQUcsS0FBQyxDQUFBLE9BQUQsQ0FBQTtZQUFILENBQWxCLEVBREc7V0FBQSxNQUFBO21CQUdILEtBQUssQ0FBQyxJQUFOLENBQVcsUUFBWCxFQUFxQixRQUFyQixFQUhHOztRQUpLLENBQVo7TUFWVztJQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBYjtJQW1CQSxJQUFDLENBQUEsRUFBRCxDQUFJLFNBQUosRUFBZSxDQUFBLFNBQUEsS0FBQTthQUFBLFNBQUE7ZUFDYixLQUFDLENBQUEsT0FBRCxDQUFBO01BRGE7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQWY7V0FNQSxNQUFNLENBQUMsUUFBUCxHQUFrQixNQUFNLENBQUMsVUFBUCxHQUFvQixDQUFBLFNBQUEsS0FBQTthQUFBLFNBQUE7ZUFBTSxLQUFDLENBQUEsT0FBRCxDQUFBO01BQU47SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBO0VBN0Q1Qjs7Ozs7O0FBZ0VkLE1BQU0sQ0FBQyxNQUFQLEdBQWdCIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBSZWFkZXJcblxuICBwcm94eSAgICA9IG51bGxcbiAgcGFnZWN0ICAgPSBudWxsXG4gIG1lbVN0b3JlID1cbiAgICBodG1sOnt9XG4gICAgYm9keTp7fVxuXG4gIGNvbnN0cnVjdG9yOiAoQG9wdGlvbnMgPSB7fSktPlxuXG4gICAgIyBjcmVhdGUgYW4gZWxlbWVudCB0byBhdHRhY2ggZXZlbnQgbGlzdGVuZXJzIHRvLiAgb25seSBuZWVkcyB0byBzdGF5IGluXG4gICAgIyBtZW1vcnksIHNvIG5vdCBhdHRhY2hpbmcgaXQgdG8gdGhlIERPTVxuICAgICNcbiAgICBwcm94eSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgcHJveHkuaWQgPSBcIl8je0RhdGUubm93KCl9XCI7XG5cbiAgICBAdXRpbHMgICAgPSBuZXcgQFV0aWxzKClcbiAgICBAcXVlcnkgICAgPSBuZXcgQFF1ZXJ5KClcbiAgICBAcGFyc2UgICAgPSBuZXcgQFBhcnNlKClcbiAgICBAbGF5b3V0ICAgPSBuZXcgQExheW91dCgpXG4gICAgQHRlbXBsYXRlID0gbmV3IEBUZW1wbGF0ZSgpXG4gICAgQGV2ZW50cyAgID0gbmV3IEBFdmVudHMoKVxuICAgIEBzd2lwZSAgICA9IG5ldyBAU3dpcGUoKVxuXG4gICAgQHBhY2thZ2UgPVxuICAgICAgYXR0cmlidXRlczogbnVsbFxuICAgICAgZ3VpZGUgICAgIDogbnVsbFxuICAgICAgbWFuaWZlc3QgIDogbnVsbFxuICAgICAgbWV0YWRhdGEgIDogbnVsbFxuICAgICAgc3BpbmUgICAgIDogbnVsbFxuICAgICAgdGV4dCAgICAgIDogbnVsbFxuXG4gICAgQGxvY2F0aW9uID1cbiAgICAgIGFzc2V0cyA6IEBvcHRpb25zLmFzc2V0cyBvciAnJ1xuICAgICAgdXJsICAgIDogXCIje3dpbmRvdy5sb2NhdGlvbi5vcmlnaW59XCIucmVwbGFjZSgvXFwvJC8sICcnKVxuXG4gICAgQG5hdiA9XG4gICAgICBlbGVtICAgICAgOiBudWxsXG4gICAgICByZWdleHAgICAgOiBudWxsXG4gICAgICBwYXRoICAgICAgOiBudWxsXG4gICAgICBhdHRyaWJ1dGUgOiBudWxsXG5cbiAgICBAbmF2TWFwICAgPSBudWxsXG4gICAgQG5jeCAgICAgID0gbnVsbFxuICAgIEBodG1sICAgICA9IFtdXG4gICAgQG1ldGFkYXRhID0gW11cblxuICAgIEBuYXZFbGVtICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWFkZXItbmF2JylcbiAgICBAbWFpbkVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVhZGVyLWZyYW1lJylcblxuXG4gIGdldE5hdkRvY3VtZW50OiAodGhhdCktPlxuICAgIHJldHVybiAoa2V5LCB2YWwsIGl0ZW0pLT5cbiAgICAgIGlmIGtleSA9PSB0aGF0Lm5hdi5hdHRyaWJ1dGUgYW5kIHRoYXQubmF2LnJlZ2V4cC50ZXN0KHZhbClcbiAgICAgICAgdGhhdC5uYXYuZWxlbSA9IGl0ZW1cbiAgICAgICAgdGhhdC5uYXYucGF0aCA9IGl0ZW0uZ2V0QXR0cmlidXRlKCdocmVmJylcbiAgICAgICAgdGhhdC54bWwoKVxuXG4gIHJlbmRlclBhZ2U6ICh0aGF0KS0+XG4gICAgcmV0dXJuICh1cmwsIHBhcmVudElkLCBuYXZJZCkgLT5cbiAgICAgIHRoYXQucXVlcnkuaHRtbChcIiN7dGhhdC5sb2NhdGlvbi5hc3NldHN9LyN7dXJsfVwiKVxuICAgICAgICAuZG9uZSAoZGF0YSktPlxuICAgICAgICAgIGRvYyA9IHRoYXQudGVtcGxhdGUucGFyc2UoZGF0YSwgdGhhdC5sb2NhdGlvbi5hc3NldHMpXG4gICAgICAgICAgdGhhdC5sYXlvdXQucmVuZGVyKGRvYywgcGFyZW50SWQsICcjZG9jLW5hdicpXG4gICAgICAgICAgaWYgbm90IHBhZ2VjdCAtPTEgdGhlbiB0aGF0LnRyaWdnZXIoJ3BhZ2VzbG9hZGVkJywge30pXG5cbiAgeG1sOiAoKS0+XG4gICAgY3VycnkgPSBAcmVuZGVyUGFnZShAKVxuICAgIEBxdWVyeS54bWwoXCIje0Bsb2NhdGlvbi5hc3NldHN9LyN7QG5hdi5wYXRofVwiKVxuICAgICAgLmRvbmUgKGRhdGEpID0+XG4gICAgICAgIEBuY3ggPSBAcGFyc2UubmF2KGRhdGEpXG4gICAgICAgIEBuYXZNYXAgPSBAcGFyc2UubWFwTmN4KEBuY3gubmF2TWFwLm5hdlBvaW50KVxuICAgICAgICBAbGF5b3V0LmJ1aWxkKEBuYXZNYXAsIGN1cnJ5LCBAbWFpbkVsZW0uaWQpXG5cbiAgYnVpbGQ6IChkYXRhKS0+XG4gICAgY3VycnkgPSBAZ2V0TmF2RG9jdW1lbnQoQClcbiAgICBwYWdlY3QgPSBAcGFyc2UueG1sKGRhdGEsIGN1cnJ5KS5wYWNrYWdlLnNwaW5lLml0ZW1yZWYubGVuZ3RoXG5cbiAgb246IChtZXRob2QsIGNhbGxiYWNrKSAtPlxuICAgIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpXG4gICAgZXZ0LmluaXRDdXN0b21FdmVudChtZXRob2QsIHRydWUsIGZhbHNlLCB7fSlcbiAgICBwcm94eS5hZGRFdmVudExpc3RlbmVyKG1ldGhvZCwgY2FsbGJhY2spXG5cbiAgdHJpZ2dlcjogKG1ldGhvZCwgZGF0YSkgLT5cbiAgICBwcm94eS5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChtZXRob2QsIGRhdGEpKVxuXG4gIHNldHVwOigpLT5cbiAgICAjIFN0b3JlIGV4aXN0aW5nIGh0bWwvYm9keSBhdHRyaWJ1dGVzIGFuZCBhcHBseSByZWFkZXIgYXR0cmlidXRlc1xuICAgICNcbiAgICBtZW1TdG9yZS5odG1sLm92ZXJmbG93ID0gJCgnaHRtbCcpLmNzcygnb3ZlcmZsb3cnKVxuICAgIG1lbVN0b3JlLmJvZHkub3ZlcmZsb3cgPSAkKCdib2R5JykuY3NzKCdvdmVyZmxvdycpXG4gICAgJCgnaHRtbCcpLmFkZENsYXNzKCdyZWFkZXInKVxuICAgICQoJ2h0bWwsYm9keScpLmNzcyh7b3ZlcmZsb3c6J2hpZGRlbid9KVxuXG4gIGRlc3Ryb3k6KCk9PlxuICAgICMgUmVzZXQgcHJldmlvdXMgYXR0cmlidXRlcyBvbiBodG1sL2JvZHksIGFuZCByZW1vdmUgcHJveHkgZWxlbWVudFxuICAgICNcbiAgICAkKCdodG1sJykuY3NzKHtvdmVyZmxvdzptZW1TdG9yZS5odG1sLm92ZXJmbG93fSkucmVtb3ZlQ2xhc3MoJ3JlYWRlcicpXG4gICAgJCgnYm9keScpLmNzcyh7b3ZlcmZsb3c6bWVtU3RvcmUuYm9keS5vdmVyZmxvd30pXG4gICAgQGV2ZW50cy5kZXN0cm95KClcbiAgICBwcm94eSA9IHVuZGVmaW5lZFxuXG4gIGluaXRpYWxpemU6ID0+XG4gICAgdG9rZW4gPSBpZiBAb3B0aW9ucy50b2MgdGhlbiAnbmF2JyBlbHNlICduY3gnXG4gICAgYXR0ciA9IGlmIEBvcHRpb25zLnRvYyB0aGVuICdwcm9wZXJ0aWVzJyBlbHNlICdpZCdcbiAgICBAbmF2LnJlZ2V4cCA9IG5ldyBSZWdFeHAoXCJeI3t0b2tlbn0kXCIsICdpJylcbiAgICBAbmF2LmF0dHJpYnV0ZSA9IGF0dHJcbiAgICBAc2V0dXAoKVxuICAgIEBxdWVyeS54bWwoQG9wdGlvbnMucGFja2FnZVVybCkuZG9uZSAoZGF0YSkgPT4gQGJ1aWxkKGRhdGEpXG5cbiAgICBsYXlvdXRjb21wbGV0ZSA9IGZhbHNlXG4gICAgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zKSA9PlxuICAgICAgbXV0YXRpb25zLmZvckVhY2ggKG11dGF0aW9uUmVjb3JkKSA9PlxuICAgICAgICBpZiAhbGF5b3V0Y29tcGxldGVcbiAgICAgICAgICBsYXlvdXRjb21wbGV0ZSA9IHRydWVcbiAgICAgICAgICBAdHJpZ2dlcignbGF5b3V0Y29tcGxldGUnLCB7fSlcbiAgICApXG5cbiAgICBvYnNlcnZlci5vYnNlcnZlIGRvY3VtZW50LmJvZHksXG4gICAgICBjaGlsZExpc3Q6IHRydWVcbiAgICAgIGF0dHJpYnV0ZXM6IHRydWVcbiAgICAgIGF0dHJpYnV0ZUZpbHRlcjogWydzdHlsZSddXG5cbiAgICAjIFB1YmxpYyBldmVudCBsaXN0ZW5lcnNcbiAgICAjXG4gICAgQG9uICdwYWdlc2xvYWRlZCcsID0+XG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIHBhZ2VzbG9hZGVkJ1xuICAgICAgd2luZG93LnNjb3BlZFBvbHlGaWxsKGRvY3VtZW50KVxuXG4gICAgQG9uICdsYXlvdXRjb21wbGV0ZScsID0+XG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIGxheW91dGNvbXBsZXRlJ1xuICAgICAgQGV2ZW50cy5pbml0aWFsaXplKClcbiAgICAgIHNldFRpbWVvdXQgKCgpID0+IEB0cmlnZ2VyKCdyZWFkeScsIHt9KSApLCAwXG5cblxuICAgIEBvbiAnbmV4dFBhZ2UnLCA9PiBAZXZlbnRzLm5leHRQYWdlKClcbiAgICBAb24gJ3ByZXZQYWdlJywgPT4gQGV2ZW50cy5wcmV2UGFnZSgpXG5cbiAgICBAb24gJ3JlYWR5JywgPT5cbiAgICAgIGNvbnNvbGUubG9nICdSZWFkZXIgcmVhZHknXG4gICAgICAkKEBtYWluRWxlbSkuYWRkQ2xhc3MoJ3JlYWR5JylcblxuICAgICAgIyBpbml0IHNjcm9sbGluZ1xuICAgICAgI1xuICAgICAgQHN3aXBlLmluaXRpYWxpemUoKVxuXG4gICAgICAjIHNvbWUgRE9NIG1hbmlwdWxhdGlvbiBmb3IgbGluayBiZWhhdmlvdXJcbiAgICAgICNcbiAgICAgICQoJ2EnKS5lYWNoIChpLCBlbCk9PlxuICAgICAgICAkdGhpcyA9ICQoZWwpXG4gICAgICAgIGlmICR0aGlzLmF0dHIoJ2hyZWYnKS5tYXRjaCgvXiMvKVxuICAgICAgICAgIHJldHVyblxuICAgICAgICBlbHNlIGlmICR0aGlzLmF0dHIoJ2hyZWYnKS5tYXRjaCgvXig/OlxcL3x3aW5kb3cubG9jYXRpb24uaG9zdCkvKVxuICAgICAgICAgICR0aGlzLm9uICdjbGljaycsID0+IEBkZXN0cm95KClcbiAgICAgICAgZWxzZVxuICAgICAgICAgICR0aGlzLmF0dHIoJ3RhcmdldCcsICdfYmxhbmsnKVxuXG4gICAgQG9uICdkZXN0cm95JywgPT5cbiAgICAgIEBkZXN0cm95KClcblxuICAgICMgSW1wb3J0YW50IHRvIGRlc3Ryb3kgb3VyIHByb3h5IGVsZW1lbnQsIGFzIGl0IHdpbGwgY29udGludWUgdG8gaGF2ZVxuICAgICMgaGFuZGxlcnMgYXR0YWNoZWQgdW5sZXNzIGl0J3MgcmVtb3ZlZFxuICAgICNcbiAgICB3aW5kb3cub251bmxvYWQgPSB3aW5kb3cub25wb3BzdGF0ZSA9ICgpID0+IEBkZXN0cm95KClcblxuXG53aW5kb3cuUmVhZGVyID0gUmVhZGVyXG4iXX0=

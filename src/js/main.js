var Reader;

Reader = (function() {
  var memStore, proxy;

  proxy = null;

  memStore = {
    html: {},
    body: {}
  };

  function Reader(options) {
    this.options = options != null ? options : {};
    proxy = document.createElement('div');
    proxy.id = "_" + (Date.now());
    this.query = new this.Query();
    this.parse = new this.Parse();
    this.layout = new this.Layout();
    this.template = new this.Template();
    this.events = new this.Events();
    this["package"] = {
      attributes: null,
      guide: null,
      manifest: null,
      metadata: null,
      spine: null,
      text: null
    };
    this.location = {
      assets: this.options.assets || '',
      url: ("" + window.location.origin).replace(/\/$/, '')
    };
    this.nav = {
      elem: null,
      regexp: null,
      path: null,
      attribute: null
    };
    this.navMap = null;
    this.navUrl = null;
    this.ncx = null;
    this.navRe = null;
    this.html = [];
    this.metadata = [];
    this.navElem = document.getElementById('reader-nav');
    this.mainElem = document.getElementById('reader-frame');
    this.pagect = null;
    this.pagect = null;
    this.delay = 150;
  }

  Reader.prototype.getNavDocument = function(that) {
    return function(key, val, item) {
      if (key === that.nav.attribute && that.nav.regexp.test(val)) {
        that.nav.elem = item;
        that.nav.path = item.getAttribute('href');
        return that.xml();
      }
    };
  };

  Reader.prototype.renderPage = function(that) {
    return function(url, parentId, navId) {
      return that.query.html(that.location.assets + "/" + url).done(function(data) {
        var doc;
        doc = that.template.parse(data, that.location.assets);
        that.layout.render(doc, parentId, '#doc-nav');
        if (!(that.pagect -= 1)) {
          return that.trigger('pagesloaded', {});
        }
      });
    };
  };

  Reader.prototype.xml = function() {
    var curry;
    curry = this.renderPage(this);
    return this.query.xml(this.location.assets + "/" + this.nav.path).done((function(_this) {
      return function(data) {
        _this.ncx = _this.parse.nav(data);
        _this.navMap = _this.parse.mapNcx(_this.ncx.navMap.navPoint);
        return _this.layout.build(_this.navMap, curry, _this.mainElem.id);
      };
    })(this));
  };

  Reader.prototype.build = function(data) {
    var curry;
    curry = this.getNavDocument(this);
    return this.pagect = this.parse.xml(data, curry)["package"].spine.itemref.length;
  };

  Reader.prototype.on = function(method, callback) {
    var evt;
    evt = document.createEvent('CustomEvent');
    evt.initCustomEvent(method, true, false, {});
    return proxy.addEventListener(method, callback);
  };

  Reader.prototype.trigger = function(method, data) {
    return proxy.dispatchEvent(new CustomEvent(method, data));
  };

  Reader.prototype.setup = function() {
    memStore.html.overflow = $('html').css('overflow');
    memStore.body.overflow = $('body').css('overflow');
    return $('html,body').css({
      overflow: 'hidden'
    });
  };

  Reader.prototype.destroy = function() {
    $('html').css({
      overflow: memStore.html.overflow
    });
    $('body').css({
      overflow: memStore.body.overflow
    });
    return proxy = void 0;
  };

  Reader.prototype.initialize = function() {
    var attr, bounceResize, layoutcomplete, observer, target, token;
    token = this.options.toc ? 'nav' : 'ncx';
    attr = this.options.toc ? 'properties' : 'id';
    this.nav.regexp = new RegExp("^" + token + "$", 'i');
    this.nav.attribute = attr;
    this.setup();
    this.query.xml(this.options.packageUrl).done((function(_this) {
      return function(data) {
        return _this.build(data);
      };
    })(this));
    layoutcomplete = false;
    observer = new MutationObserver((function(_this) {
      return function(mutations) {
        return mutations.forEach(function(mutationRecord) {
          if (!layoutcomplete) {
            layoutcomplete = true;
            return _this.trigger('layoutcomplete', {});
          }
        });
      };
    })(this));
    target = document.body;
    observer.observe(target, {
      childList: true,
      attributes: true,
      attributeFilter: ['style']
    });
    this.on('pagesloaded', (function(_this) {
      return function() {
        console.log('Reader pagesloaded');
        return window.scopedPolyFill(document);
      };
    })(this));
    this.on('layoutcomplete', (function(_this) {
      return function() {
        console.log('Reader layoutcomplete');
        _this.events.initialize();
        return setTimeout(function() {
          return _this.trigger('ready', {});
        });
      };
    })(this));
    this.on('ready', (function(_this) {
      return function() {
        console.log('Reader ready');
        return $(_this.mainElem).addClass('ready');
      };
    })(this));
    this.on('destroy', (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this));
    bounceResize = this.events.debounce((function(_this) {
      return function() {
        _this.events.setColGap();
        _this.events.setFrameWidth();
        return _this.events.setArticlePos();
      };
    })(this), this.delay);
    $(window).on('resize', bounceResize);
    window.onunload = window.onpopstate = (function(_this) {
      return function() {
        return _this.destroy();
      };
    })(this);
    return $("a[href^=\"/\"],a[href^=\"https?://(www\.)?" + window.location.host + "\"]").on('click', (function(_this) {
      return function(e) {
        return _this.destroy();
      };
    })(this));
  };

  return Reader;

})();

window.Reader = Reader;

//# sourceMappingURL=data:application/json;base64,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QSxDQUFqQixFQUliLElBQUMsQ0FBQSxLQUpZO0lBTWYsQ0FBQSxDQUFFLE1BQUYsQ0FBUyxDQUFDLEVBQVYsQ0FBYSxRQUFiLEVBQXVCLFlBQXZCO0lBS0EsTUFBTSxDQUFDLFFBQVAsR0FBa0IsTUFBTSxDQUFDLFVBQVAsR0FBb0IsQ0FBQSxTQUFBLEtBQUE7YUFBQSxTQUFBO2VBQU0sS0FBQyxDQUFBLE9BQUQsQ0FBQTtNQUFOO0lBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQTtXQUN0QyxDQUFBLENBQUUsNENBQUEsR0FBNkMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUE3RCxHQUFrRSxLQUFwRSxDQUF5RSxDQUFDLEVBQTFFLENBQTZFLE9BQTdFLEVBQXNGLENBQUEsU0FBQSxLQUFBO2FBQUEsU0FBQyxDQUFEO2VBQ3BGLEtBQUMsQ0FBQSxPQUFELENBQUE7TUFEb0Y7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQXRGO0VBdERVOzs7Ozs7QUEwRGQsTUFBTSxDQUFDLE1BQVAsR0FBZ0IiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIFJlYWRlclxuXG4gIHByb3h5ID0gbnVsbFxuICBtZW1TdG9yZSA9XG4gICAgaHRtbDp7fVxuICAgIGJvZHk6e31cblxuICBjb25zdHJ1Y3RvcjogKEBvcHRpb25zID0ge30pLT5cblxuICAgICMgY3JlYXRlIGFuIGVsZW1lbnQgdG8gYXR0YWNoIGV2ZW50IGxpc3RlbmVycyB0by4gIG9ubHkgbmVlZHMgdG8gc3RheSBpblxuICAgICMgbWVtb3J5LCBzbyBub3QgYXR0YWNoaW5nIGl0IHRvIHRoZSBET01cbiAgICAjXG4gICAgcHJveHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIHByb3h5LmlkID0gXCJfI3tEYXRlLm5vdygpfVwiO1xuXG4gICAgQHF1ZXJ5ICAgID0gbmV3IEBRdWVyeSgpXG4gICAgQHBhcnNlICAgID0gbmV3IEBQYXJzZSgpXG4gICAgQGxheW91dCAgID0gbmV3IEBMYXlvdXQoKVxuICAgIEB0ZW1wbGF0ZSA9IG5ldyBAVGVtcGxhdGUoKVxuICAgIEBldmVudHMgICA9IG5ldyBARXZlbnRzKClcblxuICAgIEBwYWNrYWdlID1cbiAgICAgIGF0dHJpYnV0ZXM6IG51bGxcbiAgICAgIGd1aWRlICAgICA6IG51bGxcbiAgICAgIG1hbmlmZXN0ICA6IG51bGxcbiAgICAgIG1ldGFkYXRhICA6IG51bGxcbiAgICAgIHNwaW5lICAgICA6IG51bGxcbiAgICAgIHRleHQgICAgICA6IG51bGxcblxuICAgIEBsb2NhdGlvbiA9XG4gICAgICBhc3NldHMgOiBAb3B0aW9ucy5hc3NldHMgb3IgJydcbiAgICAgIHVybCAgICA6IFwiI3t3aW5kb3cubG9jYXRpb24ub3JpZ2lufVwiLnJlcGxhY2UoL1xcLyQvLCAnJylcblxuICAgIEBuYXYgPVxuICAgICAgZWxlbSAgICAgIDogbnVsbFxuICAgICAgcmVnZXhwICAgIDogbnVsbFxuICAgICAgcGF0aCAgICAgIDogbnVsbFxuICAgICAgYXR0cmlidXRlIDogbnVsbFxuXG4gICAgQG5hdk1hcCAgID0gbnVsbFxuICAgIEBuYXZVcmwgICA9IG51bGxcbiAgICBAbmN4ICAgICAgPSBudWxsXG4gICAgQG5hdlJlICAgID0gbnVsbFxuICAgIEBodG1sICAgICA9IFtdXG4gICAgQG1ldGFkYXRhID0gW11cblxuICAgIEBuYXZFbGVtICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWFkZXItbmF2JylcbiAgICBAbWFpbkVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVhZGVyLWZyYW1lJylcbiAgICBAcGFnZWN0ICAgPSBudWxsXG4gICAgQHBhZ2VjdCAgID0gbnVsbFxuICAgIEBkZWxheSAgICA9IDE1MFxuXG5cbiAgZ2V0TmF2RG9jdW1lbnQ6ICh0aGF0KS0+XG4gICAgcmV0dXJuIChrZXksIHZhbCwgaXRlbSktPlxuICAgICAgaWYga2V5ID09IHRoYXQubmF2LmF0dHJpYnV0ZSBhbmQgdGhhdC5uYXYucmVnZXhwLnRlc3QodmFsKVxuICAgICAgICB0aGF0Lm5hdi5lbGVtID0gaXRlbVxuICAgICAgICB0aGF0Lm5hdi5wYXRoID0gaXRlbS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKVxuICAgICAgICB0aGF0LnhtbCgpXG5cbiAgcmVuZGVyUGFnZTogKHRoYXQpLT5cbiAgICByZXR1cm4gKHVybCwgcGFyZW50SWQsIG5hdklkKSAtPlxuICAgICAgdGhhdC5xdWVyeS5odG1sKFwiI3t0aGF0LmxvY2F0aW9uLmFzc2V0c30vI3t1cmx9XCIpXG4gICAgICAgIC5kb25lIChkYXRhKS0+XG4gICAgICAgICAgZG9jID0gdGhhdC50ZW1wbGF0ZS5wYXJzZShkYXRhLCB0aGF0LmxvY2F0aW9uLmFzc2V0cylcbiAgICAgICAgICB0aGF0LmxheW91dC5yZW5kZXIoZG9jLCBwYXJlbnRJZCwgJyNkb2MtbmF2JylcbiAgICAgICAgICBpZiBub3QgdGhhdC5wYWdlY3QgLT0xIHRoZW4gdGhhdC50cmlnZ2VyKCdwYWdlc2xvYWRlZCcsIHt9KVxuXG4gIHhtbDogKCktPlxuICAgIGN1cnJ5ID0gQHJlbmRlclBhZ2UoQClcbiAgICBAcXVlcnkueG1sKFwiI3tAbG9jYXRpb24uYXNzZXRzfS8je0BuYXYucGF0aH1cIilcbiAgICAgIC5kb25lIChkYXRhKSA9PlxuICAgICAgICBAbmN4ID0gQHBhcnNlLm5hdihkYXRhKVxuICAgICAgICBAbmF2TWFwID0gQHBhcnNlLm1hcE5jeChAbmN4Lm5hdk1hcC5uYXZQb2ludClcbiAgICAgICAgQGxheW91dC5idWlsZChAbmF2TWFwLCBjdXJyeSwgQG1haW5FbGVtLmlkKVxuXG4gIGJ1aWxkOiAoZGF0YSktPlxuICAgIGN1cnJ5ID0gQGdldE5hdkRvY3VtZW50KEApXG4gICAgQHBhZ2VjdCA9IEBwYXJzZS54bWwoZGF0YSwgY3VycnkpLnBhY2thZ2Uuc3BpbmUuaXRlbXJlZi5sZW5ndGhcblxuICBvbjogKG1ldGhvZCwgY2FsbGJhY2spIC0+XG4gICAgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0N1c3RvbUV2ZW50JylcbiAgICBldnQuaW5pdEN1c3RvbUV2ZW50KG1ldGhvZCwgdHJ1ZSwgZmFsc2UsIHt9KVxuICAgIHByb3h5LmFkZEV2ZW50TGlzdGVuZXIobWV0aG9kLCBjYWxsYmFjaylcblxuICB0cmlnZ2VyOiAobWV0aG9kLCBkYXRhKSAtPlxuICAgIHByb3h5LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KG1ldGhvZCwgZGF0YSkpXG5cbiAgc2V0dXA6KCktPlxuICAgICMgU3RvcmUgZXhpc3RpbmcgaHRtbC9ib2R5IGF0dHJpYnV0ZXMgYW5kIGFwcGx5IHJlYWRlciBhdHRyaWJ1dGVzXG4gICAgI1xuICAgIG1lbVN0b3JlLmh0bWwub3ZlcmZsb3cgPSAkKCdodG1sJykuY3NzKCdvdmVyZmxvdycpXG4gICAgbWVtU3RvcmUuYm9keS5vdmVyZmxvdyA9ICQoJ2JvZHknKS5jc3MoJ292ZXJmbG93JylcbiAgICAkKCdodG1sLGJvZHknKS5jc3Moe292ZXJmbG93OidoaWRkZW4nfSlcblxuICBkZXN0cm95OigpLT5cbiAgICAjIFJlc2V0IHByZXZpb3VzIGF0dHJpYnV0ZXMgb24gaHRtbC9ib2R5LCBhbmQgcmVtb3ZlIHByb3h5IGVsZW1lbnRcbiAgICAjXG4gICAgJCgnaHRtbCcpLmNzcyh7b3ZlcmZsb3c6bWVtU3RvcmUuaHRtbC5vdmVyZmxvd30pXG4gICAgJCgnYm9keScpLmNzcyh7b3ZlcmZsb3c6bWVtU3RvcmUuYm9keS5vdmVyZmxvd30pXG4gICAgcHJveHkgPSB1bmRlZmluZWRcblxuICBpbml0aWFsaXplOiAtPlxuICAgIHRva2VuID0gaWYgQG9wdGlvbnMudG9jIHRoZW4gJ25hdicgZWxzZSAnbmN4J1xuICAgIGF0dHIgPSBpZiBAb3B0aW9ucy50b2MgdGhlbiAncHJvcGVydGllcycgZWxzZSAnaWQnXG4gICAgQG5hdi5yZWdleHAgPSBuZXcgUmVnRXhwKFwiXiN7dG9rZW59JFwiLCAnaScpXG4gICAgQG5hdi5hdHRyaWJ1dGUgPSBhdHRyXG4gICAgQHNldHVwKClcbiAgICBAcXVlcnkueG1sKEBvcHRpb25zLnBhY2thZ2VVcmwpLmRvbmUgKGRhdGEpID0+IEBidWlsZChkYXRhKVxuXG4gICAgbGF5b3V0Y29tcGxldGUgPSBmYWxzZVxuICAgIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKG11dGF0aW9ucykgPT5cbiAgICAgIG11dGF0aW9ucy5mb3JFYWNoIChtdXRhdGlvblJlY29yZCkgPT5cbiAgICAgICAgaWYgIWxheW91dGNvbXBsZXRlXG4gICAgICAgICAgbGF5b3V0Y29tcGxldGUgPSB0cnVlXG4gICAgICAgICAgQHRyaWdnZXIoJ2xheW91dGNvbXBsZXRlJywge30pXG4gICAgKVxuXG4gICAgdGFyZ2V0ID0gZG9jdW1lbnQuYm9keVxuICAgIG9ic2VydmVyLm9ic2VydmUgdGFyZ2V0LFxuICAgICAgY2hpbGRMaXN0OiB0cnVlXG4gICAgICBhdHRyaWJ1dGVzOiB0cnVlXG4gICAgICBhdHRyaWJ1dGVGaWx0ZXI6IFsnc3R5bGUnXVxuXG4gICAgIyBQdWJsaWMgZXZlbnQgbGlzdGVuZXJzXG4gICAgI1xuICAgIEBvbiAncGFnZXNsb2FkZWQnLCA9PlxuICAgICAgY29uc29sZS5sb2cgJ1JlYWRlciBwYWdlc2xvYWRlZCdcbiAgICAgIHdpbmRvdy5zY29wZWRQb2x5RmlsbChkb2N1bWVudClcblxuICAgIEBvbiAnbGF5b3V0Y29tcGxldGUnLCA9PlxuICAgICAgY29uc29sZS5sb2cgJ1JlYWRlciBsYXlvdXRjb21wbGV0ZSdcbiAgICAgIEBldmVudHMuaW5pdGlhbGl6ZSgpXG4gICAgICBzZXRUaW1lb3V0ID0+IEB0cmlnZ2VyKCdyZWFkeScsIHt9KVxuXG4gICAgQG9uICdyZWFkeScsID0+XG4gICAgICBjb25zb2xlLmxvZyAnUmVhZGVyIHJlYWR5J1xuICAgICAgJChAbWFpbkVsZW0pLmFkZENsYXNzKCdyZWFkeScpXG5cbiAgICBAb24gJ2Rlc3Ryb3knLCA9PlxuICAgICAgQGRlc3Ryb3koKVxuXG4gICAgIyBFdmVudCBoYW5kbGVyc1xuICAgICNcbiAgICBib3VuY2VSZXNpemUgPSBAZXZlbnRzLmRlYm91bmNlICgpPT5cbiAgICAgIEBldmVudHMuc2V0Q29sR2FwKClcbiAgICAgIEBldmVudHMuc2V0RnJhbWVXaWR0aCgpXG4gICAgICBAZXZlbnRzLnNldEFydGljbGVQb3MoKVxuICAgICwgQGRlbGF5XG5cbiAgICAkKHdpbmRvdykub24gJ3Jlc2l6ZScsIGJvdW5jZVJlc2l6ZVxuXG4gICAgIyBJbXBvcnRhbnQgdG8gZGVzdHJveSBvdXIgcHJveHkgZWxlbWVudCwgYXMgaXQgd2lsbCBjb250aW51ZSB0byBoYXZlXG4gICAgIyBoYW5kbGVycyBhdHRhY2hlZCB1bmxlc3MgaXQncyByZW1vdmVkXG4gICAgI1xuICAgIHdpbmRvdy5vbnVubG9hZCA9IHdpbmRvdy5vbnBvcHN0YXRlID0gKCkgPT4gQGRlc3Ryb3koKVxuICAgICQoXCJhW2hyZWZePVxcXCIvXFxcIl0sYVtocmVmXj1cXFwiaHR0cHM/Oi8vKHd3d1xcLik/I3t3aW5kb3cubG9jYXRpb24uaG9zdH1cXFwiXVwiKS5vbiAnY2xpY2snLCAoZSkgPT5cbiAgICAgIEBkZXN0cm95KClcblxuXG53aW5kb3cuUmVhZGVyID0gUmVhZGVyXG4iXX0=

var Reader;

Reader = (function() {
  function Reader(options) {
    this.options = options != null ? options : {};
    this.query = new this.Query();
    this.parse = new this.Parse();
    this.layout = new this.Layout();
    this.aspect = new this.Aspect();
    this.template = new this.Template();
    this.events = new this.Events();
    this["package"] = {
      attributes: null,
      guide: null,
      manifest: null,
      metadata: null,
      spine: null,
      text: null
    };
    this.location = {
      assets: this.options.assets || '',
      url: ("" + window.location.origin).replace(/\/$/, '')
    };
    this.nav = {
      elem: null,
      regexp: null,
      path: null,
      attribute: null
    };
    this.navMap = null;
    this.navUrl = null;
    this.ncx = null;
    this.navRe = null;
    this.html = [];
    this.metadata = [];
    this.navElem = document.getElementById('reader-nav');
    this.mainElem = document.getElementById('reader-frame');
    this.pagect = null;
    this.pagect = null;
    this.delay = 150;
  }

  Reader.prototype.getNavDocument = function(that) {
    return function(key, val, item) {
      if (key === that.nav.attribute && that.nav.regexp.test(val)) {
        that.nav.elem = item;
        that.nav.path = item.getAttribute('href');
        return that.xml();
      }
    };
  };

  Reader.prototype.renderPage = function(that) {
    return function(url, parentId, navId) {
      return that.query.html(that.location.assets + "/" + url).done(function(data) {
        var doc;
        doc = that.template.parse(data, that.location.assets);
        that.layout.render(doc, parentId, '#doc-nav');
        if (!(that.pagect -= 1)) {
          return that.trigger('pagesloaded', {});
        }
      });
    };
  };

  Reader.prototype.xml = function() {
    var curry;
    curry = this.renderPage(this);
    return this.query.xml(this.location.assets + "/" + this.nav.path).done((function(_this) {
      return function(data) {
        _this.ncx = _this.parse.nav(data);
        _this.navMap = _this.parse.mapNcx(_this.ncx.navMap.navPoint);
        return _this.layout.build(_this.navMap, curry, _this.mainElem.id);
      };
    })(this));
  };

  Reader.prototype.build = function(data) {
    var curry;
    curry = this.getNavDocument(this);
    return this.pagect = this.parse.xml(data, curry)["package"].spine.itemref.length;
  };

  Reader.prototype.on = function(handle, callback) {
    var evt;
    evt = document.createEvent('CustomEvent');
    evt.initCustomEvent(handle, true, false, {});
    return this.mainElem.addEventListener(handle, callback);
  };

  Reader.prototype.trigger = function(handle, data) {
    return this.mainElem.dispatchEvent(new CustomEvent(handle, data));
  };

  Reader.prototype.initialize = function() {
    var attr, bounceResize, bounceReturnToPos, layoutcomplete, observer, target, token;
    token = this.options.toc ? 'nav' : 'ncx';
    attr = this.options.toc ? 'properties' : 'id';
    this.nav.regexp = new RegExp("^" + token + "$", 'i');
    this.nav.attribute = attr;
    this.query.xml(this.options.packageUrl).done((function(_this) {
      return function(data) {
        return _this.build(data);
      };
    })(this));
    layoutcomplete = false;
    observer = new MutationObserver((function(_this) {
      return function(mutations) {
        mutations.forEach(function(mutationRecord) {
          if (!layoutcomplete) {
            layoutcomplete = true;
            _this.trigger('layoutcomplete', {});
          }
        });
      };
    })(this));
    target = document.body;
    observer.observe(target, {
      childList: true,
      attributes: true,
      attributeFilter: ['style']
    });
    this.on('pagesloaded', (function(_this) {
      return function() {
        return console.log('Reader pagesloaded');
      };
    })(this));
    this.on('layoutcomplete', (function(_this) {
      return function() {
        console.log('Reader layoutcomplete');
        _this.events.frameWidth = _this.events.setFrameWidth();
        _this.events.colGap = _this.events.setColGap();
        _this.events.setArticlePos();
        _this.events.bindElems();
        return setTimeout(function() {
          return _this.trigger('ready', {});
        });
      };
    })(this));
    this.on('ready', (function(_this) {
      return function() {
        console.log('Reader ready');
        return $(_this.mainElem).css({
          opacity: 1
        });
      };
    })(this));
    bounceResize = this.events.debounce((function(_this) {
      return function() {
        _this.events.setColGap();
        _this.events.setFrameWidth();
        return _this.events.setArticlePos();
      };
    })(this), this.delay);
    bounceReturnToPos = this.events.debounce((function(_this) {
      return function() {
        return _this.events.returnToPos();
      };
    })(this), this.delay * 2);
    $(window).on('resize', bounceReturnToPos);
    return $(window).on('resize', bounceResize);
  };

  return Reader;

})();

window.Reader = Reader;

//# sourceMappingURL=data:application/json;base64,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UixDQUFZLGNBQVo7ZUFDQSxDQUFBLENBQUUsS0FBQyxDQUFBLFFBQUgsQ0FBWSxDQUFDLEdBQWIsQ0FBaUI7VUFBQyxPQUFBLEVBQVEsQ0FBVDtTQUFqQjtNQUZXO0lBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFiO0lBSUEsWUFBQSxHQUFlLElBQUMsQ0FBQSxNQUFNLENBQUMsUUFBUixDQUFpQixDQUFBLFNBQUEsS0FBQTthQUFBLFNBQUE7UUFDOUIsS0FBQyxDQUFBLE1BQU0sQ0FBQyxTQUFSLENBQUE7UUFDQSxLQUFDLENBQUEsTUFBTSxDQUFDLGFBQVIsQ0FBQTtlQUNBLEtBQUMsQ0FBQSxNQUFNLENBQUMsYUFBUixDQUFBO01BSDhCO0lBQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQUFqQixFQUliLElBQUMsQ0FBQSxLQUpZO0lBTWYsaUJBQUEsR0FBb0IsSUFBQyxDQUFBLE1BQU0sQ0FBQyxRQUFSLENBQWlCLENBQUEsU0FBQSxLQUFBO2FBQUEsU0FBQTtlQUVuQyxLQUFDLENBQUEsTUFBTSxDQUFDLFdBQVIsQ0FBQTtNQUZtQztJQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBakIsRUFHbEIsSUFBQyxDQUFBLEtBQUQsR0FBUyxDQUhTO0lBS3BCLENBQUEsQ0FBRSxNQUFGLENBQVMsQ0FBQyxFQUFWLENBQWEsUUFBYixFQUF1QixpQkFBdkI7V0FDQSxDQUFBLENBQUUsTUFBRixDQUFTLENBQUMsRUFBVixDQUFhLFFBQWIsRUFBdUIsWUFBdkI7RUFsRFU7Ozs7OztBQXFEZCxNQUFNLENBQUMsTUFBUCxHQUFnQiIsImZpbGUiOiJtYWluLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgUmVhZGVyXG5cbiAgY29uc3RydWN0b3I6IChAb3B0aW9ucyA9IHt9KS0+XG5cbiAgICBAcXVlcnkgICAgPSBuZXcgQFF1ZXJ5KClcbiAgICBAcGFyc2UgICAgPSBuZXcgQFBhcnNlKClcbiAgICBAbGF5b3V0ICAgPSBuZXcgQExheW91dCgpXG4gICAgQGFzcGVjdCAgID0gbmV3IEBBc3BlY3QoKVxuICAgIEB0ZW1wbGF0ZSA9IG5ldyBAVGVtcGxhdGUoKVxuICAgIEBldmVudHMgICA9IG5ldyBARXZlbnRzKClcblxuICAgIEBwYWNrYWdlID1cbiAgICAgIGF0dHJpYnV0ZXM6IG51bGxcbiAgICAgIGd1aWRlICAgICA6IG51bGxcbiAgICAgIG1hbmlmZXN0ICA6IG51bGxcbiAgICAgIG1ldGFkYXRhICA6IG51bGxcbiAgICAgIHNwaW5lICAgICA6IG51bGxcbiAgICAgIHRleHQgICAgICA6IG51bGxcblxuICAgIEBsb2NhdGlvbiA9XG4gICAgICBhc3NldHMgOiBAb3B0aW9ucy5hc3NldHMgb3IgJydcbiAgICAgIHVybCAgICA6IFwiI3t3aW5kb3cubG9jYXRpb24ub3JpZ2lufVwiLnJlcGxhY2UoL1xcLyQvLCAnJylcblxuICAgIEBuYXYgPVxuICAgICAgZWxlbSAgICAgIDogbnVsbFxuICAgICAgcmVnZXhwICAgIDogbnVsbFxuICAgICAgcGF0aCAgICAgIDogbnVsbFxuICAgICAgYXR0cmlidXRlIDogbnVsbFxuXG4gICAgQG5hdk1hcCAgID0gbnVsbFxuICAgIEBuYXZVcmwgICA9IG51bGxcbiAgICBAbmN4ICAgICAgPSBudWxsXG4gICAgQG5hdlJlICAgID0gbnVsbFxuICAgIEBodG1sICAgICA9IFtdXG4gICAgQG1ldGFkYXRhID0gW11cblxuICAgIEBuYXZFbGVtICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWFkZXItbmF2JylcbiAgICBAbWFpbkVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVhZGVyLWZyYW1lJylcbiAgICBAcGFnZWN0ICAgPSBudWxsXG4gICAgQHBhZ2VjdCAgID0gbnVsbFxuICAgIEBkZWxheSAgICA9IDE1MFxuXG5cbiAgZ2V0TmF2RG9jdW1lbnQ6ICh0aGF0KS0+XG4gICAgcmV0dXJuIChrZXksIHZhbCwgaXRlbSktPlxuICAgICAgaWYga2V5ID09IHRoYXQubmF2LmF0dHJpYnV0ZSBhbmQgdGhhdC5uYXYucmVnZXhwLnRlc3QodmFsKVxuICAgICAgICB0aGF0Lm5hdi5lbGVtID0gaXRlbVxuICAgICAgICB0aGF0Lm5hdi5wYXRoID0gaXRlbS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKVxuICAgICAgICB0aGF0LnhtbCgpXG5cbiAgcmVuZGVyUGFnZTogKHRoYXQpLT5cbiAgICByZXR1cm4gKHVybCwgcGFyZW50SWQsIG5hdklkKSAtPlxuICAgICAgdGhhdC5xdWVyeS5odG1sKFwiI3t0aGF0LmxvY2F0aW9uLmFzc2V0c30vI3t1cmx9XCIpXG4gICAgICAgIC5kb25lIChkYXRhKS0+XG4gICAgICAgICAgZG9jID0gdGhhdC50ZW1wbGF0ZS5wYXJzZShkYXRhLCB0aGF0LmxvY2F0aW9uLmFzc2V0cylcbiAgICAgICAgICB0aGF0LmxheW91dC5yZW5kZXIoZG9jLCBwYXJlbnRJZCwgJyNkb2MtbmF2JylcbiAgICAgICAgICBpZiBub3QgdGhhdC5wYWdlY3QgLT0xIHRoZW4gdGhhdC50cmlnZ2VyKCdwYWdlc2xvYWRlZCcsIHt9KVxuXG4gIHhtbDogKCktPlxuICAgIGN1cnJ5ID0gQHJlbmRlclBhZ2UoQClcbiAgICBAcXVlcnkueG1sKFwiI3tAbG9jYXRpb24uYXNzZXRzfS8je0BuYXYucGF0aH1cIilcbiAgICAgIC5kb25lIChkYXRhKSA9PlxuICAgICAgICBAbmN4ID0gQHBhcnNlLm5hdihkYXRhKVxuICAgICAgICBAbmF2TWFwID0gQHBhcnNlLm1hcE5jeChAbmN4Lm5hdk1hcC5uYXZQb2ludClcbiAgICAgICAgQGxheW91dC5idWlsZChAbmF2TWFwLCBjdXJyeSwgQG1haW5FbGVtLmlkKVxuXG4gIGJ1aWxkOiAoZGF0YSktPlxuICAgIGN1cnJ5ID0gQGdldE5hdkRvY3VtZW50KEApXG4gICAgQHBhZ2VjdCA9IEBwYXJzZS54bWwoZGF0YSwgY3VycnkpLnBhY2thZ2Uuc3BpbmUuaXRlbXJlZi5sZW5ndGhcblxuICBvbjogKGhhbmRsZSwgY2FsbGJhY2spIC0+XG4gICAgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0N1c3RvbUV2ZW50JylcbiAgICBldnQuaW5pdEN1c3RvbUV2ZW50KGhhbmRsZSwgdHJ1ZSwgZmFsc2UsIHt9KVxuICAgIEBtYWluRWxlbS5hZGRFdmVudExpc3RlbmVyKGhhbmRsZSwgY2FsbGJhY2spXG5cbiAgdHJpZ2dlcjogKGhhbmRsZSwgZGF0YSkgLT5cbiAgICBAbWFpbkVsZW0uZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoaGFuZGxlLCBkYXRhKSlcblxuICBpbml0aWFsaXplOiAtPlxuICAgIHRva2VuID0gaWYgQG9wdGlvbnMudG9jIHRoZW4gJ25hdicgZWxzZSAnbmN4J1xuICAgIGF0dHIgPSBpZiBAb3B0aW9ucy50b2MgdGhlbiAncHJvcGVydGllcycgZWxzZSAnaWQnXG4gICAgQG5hdi5yZWdleHAgPSBuZXcgUmVnRXhwKFwiXiN7dG9rZW59JFwiLCAnaScpXG4gICAgQG5hdi5hdHRyaWJ1dGUgPSBhdHRyXG4gICAgQHF1ZXJ5LnhtbChAb3B0aW9ucy5wYWNrYWdlVXJsKS5kb25lIChkYXRhKSA9PiBAYnVpbGQoZGF0YSlcblxuICAgIGxheW91dGNvbXBsZXRlID0gZmFsc2VcbiAgICBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChtdXRhdGlvbnMpID0+XG4gICAgICBtdXRhdGlvbnMuZm9yRWFjaCAobXV0YXRpb25SZWNvcmQpID0+XG4gICAgICAgIGlmICFsYXlvdXRjb21wbGV0ZVxuICAgICAgICAgIGxheW91dGNvbXBsZXRlID0gdHJ1ZVxuICAgICAgICAgIEB0cmlnZ2VyKCdsYXlvdXRjb21wbGV0ZScsIHt9KVxuICAgICAgICByZXR1cm5cbiAgICAgIHJldHVyblxuICAgIClcbiAgICB0YXJnZXQgPSBkb2N1bWVudC5ib2R5XG4gICAgb2JzZXJ2ZXIub2JzZXJ2ZSB0YXJnZXQsXG4gICAgICBjaGlsZExpc3Q6IHRydWVcbiAgICAgIGF0dHJpYnV0ZXM6IHRydWVcbiAgICAgIGF0dHJpYnV0ZUZpbHRlcjogWyAnc3R5bGUnIF1cblxuICAgIEBvbiAncGFnZXNsb2FkZWQnLCA9PlxuICAgICAgY29uc29sZS5sb2cgJ1JlYWRlciBwYWdlc2xvYWRlZCdcblxuICAgIEBvbiAnbGF5b3V0Y29tcGxldGUnLCA9PlxuICAgICAgY29uc29sZS5sb2cgJ1JlYWRlciBsYXlvdXRjb21wbGV0ZSdcbiAgICAgIEBldmVudHMuZnJhbWVXaWR0aCA9IEBldmVudHMuc2V0RnJhbWVXaWR0aCgpXG4gICAgICBAZXZlbnRzLmNvbEdhcCA9IEBldmVudHMuc2V0Q29sR2FwKClcbiAgICAgIEBldmVudHMuc2V0QXJ0aWNsZVBvcygpXG4gICAgICBAZXZlbnRzLmJpbmRFbGVtcygpXG5cbiAgICAgIHNldFRpbWVvdXQgPT4gQHRyaWdnZXIoJ3JlYWR5Jywge30pXG5cbiAgICBAb24gJ3JlYWR5JywgPT5cbiAgICAgIGNvbnNvbGUubG9nICdSZWFkZXIgcmVhZHknXG4gICAgICAkKEBtYWluRWxlbSkuY3NzKHtvcGFjaXR5OjF9KVxuXG4gICAgYm91bmNlUmVzaXplID0gQGV2ZW50cy5kZWJvdW5jZSAoKT0+XG4gICAgICBAZXZlbnRzLnNldENvbEdhcCgpXG4gICAgICBAZXZlbnRzLnNldEZyYW1lV2lkdGgoKVxuICAgICAgQGV2ZW50cy5zZXRBcnRpY2xlUG9zKClcbiAgICAsIEBkZWxheVxuXG4gICAgYm91bmNlUmV0dXJuVG9Qb3MgPSBAZXZlbnRzLmRlYm91bmNlICgpPT5cbiAgICAgICMgdGhpcyBzaG91bGQgYmUgY2FsbGVkIGJ5IGBzZXRBcnRpY2xlUG9zKClgIGluc3RlYWQgb2Ygc2V0dGltZW91dFxuICAgICAgQGV2ZW50cy5yZXR1cm5Ub1BvcygpXG4gICAgLCBAZGVsYXkgKiAyXG5cbiAgICAkKHdpbmRvdykub24gJ3Jlc2l6ZScsIGJvdW5jZVJldHVyblRvUG9zXG4gICAgJCh3aW5kb3cpLm9uICdyZXNpemUnLCBib3VuY2VSZXNpemVcblxuXG53aW5kb3cuUmVhZGVyID0gUmVhZGVyXG4iXX0=

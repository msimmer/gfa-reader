var App;

App = (function() {
  function App(options) {
    this.options = options != null ? options : {};
    this.query = new this.Query();
    this.parse = new this.Parse();
    this.layout = new this.Layout();
    this.aspect = new this.Aspect();
    this["package"] = {
      attributes: null,
      guide: null,
      manifest: null,
      metadata: null,
      spine: null,
      text: null
    };
    this.location = {
      assets: "/src/assets/OEBPS",
      url: ("" + window.location.origin).replace(/\/$/, '')
    };
    this.nav = {
      elem: null,
      regexp: null,
      path: null,
      attribute: null
    };
    this.navMap = null;
    this.navUrl = null;
    this.ncx = null;
    this.navRe = null;
    this.html = [];
    this.metadata = [];
  }

  App.prototype.getNavDocument = function(that) {
    return function(key, val, item) {
      if (key === that.nav.attribute && that.nav.regexp.test(val)) {
        that.nav.elem = item;
        that.nav.path = item.getAttribute('href');
        return that.xml();
      }
    };
  };

  App.prototype.renderPage = function(that) {
    return function(url, parentId) {
      return that.query.html(that.location.assets + "/" + url).done(function(data) {
        return that.layout.render(data, parentId);
      });
    };
  };

  App.prototype.xml = function() {
    var curry;
    curry = this.renderPage(this);
    return this.query.xml(this.location.assets + "/" + this.nav.path).done((function(_this) {
      return function(data) {
        _this.ncx = _this.parse.nav(data);
        _this.navMap = _this.parse.mapNcx(_this.ncx.navMap.navPoint);
        return _this.layout.build(_this.navMap, curry);
      };
    })(this));
  };

  App.prototype.build = function(data) {
    var curry;
    curry = this.getNavDocument(this);
    return this.parse.xml(data, curry);
  };

  App.prototype.initialize = function() {
    var attr, token;
    token = this.options.toc ? 'nav' : 'ncx';
    attr = this.options.toc ? 'properties' : 'id';
    this.nav.regexp = new RegExp("^" + token + "$", 'i');
    this.nav.attribute = attr;
    return this.query.xml(this.options.packageUrl).done((function(_this) {
      return function(data) {
        return _this.build(data);
      };
    })(this));
  };

  return App;

})();

window.App = App;

//# sourceMappingURL=data:application/json;base64,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RyxDQUFDLE1BQU0sQ0FBQyxRQUExQjtlQUNWLEtBQUMsQ0FBQSxNQUFNLENBQUMsS0FBUixDQUFjLEtBQUMsQ0FBQSxNQUFmLEVBQXVCLEtBQXZCO01BSEk7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBRFI7RUFGRzs7Z0JBUUwsS0FBQSxHQUFPLFNBQUMsSUFBRDtBQUNMLFFBQUE7SUFBQSxLQUFBLEdBQVEsSUFBQyxDQUFBLGNBQUQsQ0FBZ0IsSUFBaEI7V0FDUixJQUFDLENBQUEsS0FBSyxDQUFDLEdBQVAsQ0FBVyxJQUFYLEVBQWlCLEtBQWpCO0VBRks7O2dCQUlQLFVBQUEsR0FBWSxTQUFBO0FBQ1YsUUFBQTtJQUFBLEtBQUEsR0FBVyxJQUFDLENBQUEsT0FBTyxDQUFDLEdBQVosR0FBcUIsS0FBckIsR0FBZ0M7SUFDeEMsSUFBQSxHQUFVLElBQUMsQ0FBQSxPQUFPLENBQUMsR0FBWixHQUFxQixZQUFyQixHQUF1QztJQUM5QyxJQUFDLENBQUEsR0FBRyxDQUFDLE1BQUwsR0FBa0IsSUFBQSxNQUFBLENBQU8sR0FBQSxHQUFJLEtBQUosR0FBVSxHQUFqQixFQUFxQixHQUFyQjtJQUNsQixJQUFDLENBQUEsR0FBRyxDQUFDLFNBQUwsR0FBaUI7V0FDakIsSUFBQyxDQUFBLEtBQUssQ0FBQyxHQUFQLENBQVcsSUFBQyxDQUFBLE9BQU8sQ0FBQyxVQUFwQixDQUErQixDQUFDLElBQWhDLENBQXFDLENBQUEsU0FBQSxLQUFBO2FBQUEsU0FBQyxJQUFEO2VBQVUsS0FBQyxDQUFBLEtBQUQsQ0FBTyxJQUFQO01BQVY7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQXJDO0VBTFU7Ozs7OztBQU9kLE1BQU0sQ0FBQyxHQUFQLEdBQWEiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIEFwcFxuXG4gIGNvbnN0cnVjdG9yOiAoQG9wdGlvbnMgPSB7fSktPlxuXG4gICAgQHF1ZXJ5ICA9IG5ldyBAUXVlcnkoKVxuICAgIEBwYXJzZSAgPSBuZXcgQFBhcnNlKClcbiAgICBAbGF5b3V0ID0gbmV3IEBMYXlvdXQoKVxuICAgIEBhc3BlY3QgPSBuZXcgQEFzcGVjdCgpXG5cbiAgICBAcGFja2FnZSA9XG4gICAgICBhdHRyaWJ1dGVzOiBudWxsXG4gICAgICBndWlkZSAgICAgOiBudWxsXG4gICAgICBtYW5pZmVzdCAgOiBudWxsXG4gICAgICBtZXRhZGF0YSAgOiBudWxsXG4gICAgICBzcGluZSAgICAgOiBudWxsXG4gICAgICB0ZXh0ICAgICAgOiBudWxsXG5cbiAgICBAbG9jYXRpb24gPVxuICAgICAgIyBhc3NldHMgOiBudWxsXG4gICAgICAjIHVybCAgICA6IG51bGxcbiAgICAgIGFzc2V0cyAgIDogXCIvc3JjL2Fzc2V0cy9PRUJQU1wiXG4gICAgICB1cmwgICAgICA6IFwiI3t3aW5kb3cubG9jYXRpb24ub3JpZ2lufVwiLnJlcGxhY2UoL1xcLyQvLCAnJylcblxuICAgIEBuYXYgPVxuICAgICAgZWxlbSAgICAgIDogbnVsbFxuICAgICAgcmVnZXhwICAgIDogbnVsbFxuICAgICAgcGF0aCAgICAgIDogbnVsbFxuICAgICAgYXR0cmlidXRlIDogbnVsbFxuXG4gICAgQG5hdk1hcCAgID0gbnVsbFxuICAgIEBuYXZVcmwgICA9IG51bGxcbiAgICBAbmN4ICAgICAgPSBudWxsXG4gICAgQG5hdlJlICAgID0gbnVsbFxuICAgIEBodG1sICAgICA9IFtdXG4gICAgQG1ldGFkYXRhID0gW11cblxuICBnZXROYXZEb2N1bWVudDogKHRoYXQpLT5cbiAgICByZXR1cm4gKGtleSwgdmFsLCBpdGVtKS0+XG4gICAgICBpZiBrZXkgPT0gdGhhdC5uYXYuYXR0cmlidXRlIGFuZCB0aGF0Lm5hdi5yZWdleHAudGVzdCh2YWwpXG4gICAgICAgIHRoYXQubmF2LmVsZW0gPSBpdGVtXG4gICAgICAgIHRoYXQubmF2LnBhdGggPSBpdGVtLmdldEF0dHJpYnV0ZSgnaHJlZicpXG4gICAgICAgIHRoYXQueG1sKClcblxuICByZW5kZXJQYWdlOiAodGhhdCktPlxuICAgIHJldHVybiAodXJsLCBwYXJlbnRJZCkgLT5cbiAgICAgIHRoYXQucXVlcnkuaHRtbChcIiN7dGhhdC5sb2NhdGlvbi5hc3NldHN9LyN7dXJsfVwiKVxuICAgICAgICAuZG9uZSAoZGF0YSktPlxuICAgICAgICAgIHRoYXQubGF5b3V0LnJlbmRlcihkYXRhLCBwYXJlbnRJZClcblxuICB4bWw6ICgpLT5cbiAgICBjdXJyeSA9IEByZW5kZXJQYWdlKEApXG4gICAgQHF1ZXJ5LnhtbChcIiN7QGxvY2F0aW9uLmFzc2V0c30vI3tAbmF2LnBhdGh9XCIpXG4gICAgICAuZG9uZSAoZGF0YSkgPT5cbiAgICAgICAgQG5jeCA9IEBwYXJzZS5uYXYoZGF0YSlcbiAgICAgICAgQG5hdk1hcCA9IEBwYXJzZS5tYXBOY3goQG5jeC5uYXZNYXAubmF2UG9pbnQpXG4gICAgICAgIEBsYXlvdXQuYnVpbGQoQG5hdk1hcCwgY3VycnkpXG5cbiAgYnVpbGQ6IChkYXRhKS0+XG4gICAgY3VycnkgPSBAZ2V0TmF2RG9jdW1lbnQoQClcbiAgICBAcGFyc2UueG1sKGRhdGEsIGN1cnJ5KVxuXG4gIGluaXRpYWxpemU6IC0+XG4gICAgdG9rZW4gPSBpZiBAb3B0aW9ucy50b2MgdGhlbiAnbmF2JyBlbHNlICduY3gnXG4gICAgYXR0ciA9IGlmIEBvcHRpb25zLnRvYyB0aGVuICdwcm9wZXJ0aWVzJyBlbHNlICdpZCdcbiAgICBAbmF2LnJlZ2V4cCA9IG5ldyBSZWdFeHAoXCJeI3t0b2tlbn0kXCIsICdpJylcbiAgICBAbmF2LmF0dHJpYnV0ZSA9IGF0dHJcbiAgICBAcXVlcnkueG1sKEBvcHRpb25zLnBhY2thZ2VVcmwpLmRvbmUgKGRhdGEpID0+IEBidWlsZChkYXRhKVxuXG53aW5kb3cuQXBwID0gQXBwXG4iXX0=

var Reader;

Reader = (function() {
  function Reader(options1) {
    this.options = options1 != null ? options1 : {};
    this.query = new this.Query();
    this.parse = new this.Parse();
    this.layout = new this.Layout();
    this.aspect = new this.Aspect();
    this.template = new this.Template();
    this["package"] = {
      attributes: null,
      guide: null,
      manifest: null,
      metadata: null,
      spine: null,
      text: null
    };
    this.location = {
      assets: this.options.assets || '',
      url: ("" + window.location.origin).replace(/\/$/, '')
    };
    this.nav = {
      elem: null,
      regexp: null,
      path: null,
      attribute: null
    };
    this.navMap = null;
    this.navUrl = null;
    this.ncx = null;
    this.navRe = null;
    this.html = [];
    this.metadata = [];
    this.elem = document.getElementById('reader');
    this.pagect = null;
  }

  Reader.prototype.getNavDocument = function(that) {
    return function(key, val, item) {
      if (key === that.nav.attribute && that.nav.regexp.test(val)) {
        that.nav.elem = item;
        that.nav.path = item.getAttribute('href');
        return that.xml();
      }
    };
  };

  Reader.prototype.renderPage = function(that, options) {
    return function(url, parentId) {
      return that.query.html(that.location.assets + "/" + url).done(function(data) {
        var doc;
        doc = that.template.parse(data, that.location.assets);
        that.layout.render(doc, parentId);
        if (!(that.pagect -= 1)) {
          return that.trigger('pagesloaded', {});
        }
      });
    };
  };

  Reader.prototype.xml = function() {
    var curry;
    curry = this.renderPage(this, this.options);
    return this.query.xml(this.location.assets + "/" + this.nav.path).done((function(_this) {
      return function(data) {
        _this.ncx = _this.parse.nav(data);
        _this.navMap = _this.parse.mapNcx(_this.ncx.navMap.navPoint);
        return _this.layout.build(_this.navMap, curry);
      };
    })(this));
  };

  Reader.prototype.build = function(data) {
    var curry;
    curry = this.getNavDocument(this);
    return this.pagect = this.parse.xml(data, curry)["package"].spine.itemref.length;
  };

  Reader.prototype.on = function(handle, callback) {
    var evt;
    evt = document.createEvent('CustomEvent');
    evt.initCustomEvent(handle, true, false, {});
    return this.elem.addEventListener(handle, callback);
  };

  Reader.prototype.trigger = function(handle, data) {
    return this.elem.dispatchEvent(new CustomEvent(handle, data));
  };

  Reader.prototype.initialize = function() {
    var attr, token;
    token = this.options.toc ? 'nav' : 'ncx';
    attr = this.options.toc ? 'properties' : 'id';
    this.nav.regexp = new RegExp("^" + token + "$", 'i');
    this.nav.attribute = attr;
    this.query.xml(this.options.packageUrl).done((function(_this) {
      return function(data) {
        return _this.build(data);
      };
    })(this));
    return $(document).on('styles:scoped', (function(_this) {
      return function() {
        return _this.trigger('ready', {});
      };
    })(this));
  };

  return Reader;

})();

window.Reader = Reader;

//# sourceMappingURL=data:application/json;base64,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Q0FBQyxnQkFBTixDQUF1QixNQUF2QixFQUErQixRQUEvQjtFQUhFOzttQkFLSixPQUFBLEdBQVMsU0FBQyxNQUFELEVBQVMsSUFBVDtXQUNQLElBQUMsQ0FBQSxJQUFJLENBQUMsYUFBTixDQUF3QixJQUFBLFdBQUEsQ0FBWSxNQUFaLEVBQW9CLElBQXBCLENBQXhCO0VBRE87O21CQUdULFVBQUEsR0FBWSxTQUFBO0FBQ1YsUUFBQTtJQUFBLEtBQUEsR0FBVyxJQUFDLENBQUEsT0FBTyxDQUFDLEdBQVosR0FBcUIsS0FBckIsR0FBZ0M7SUFDeEMsSUFBQSxHQUFVLElBQUMsQ0FBQSxPQUFPLENBQUMsR0FBWixHQUFxQixZQUFyQixHQUF1QztJQUM5QyxJQUFDLENBQUEsR0FBRyxDQUFDLE1BQUwsR0FBa0IsSUFBQSxNQUFBLENBQU8sR0FBQSxHQUFJLEtBQUosR0FBVSxHQUFqQixFQUFxQixHQUFyQjtJQUNsQixJQUFDLENBQUEsR0FBRyxDQUFDLFNBQUwsR0FBaUI7SUFDakIsSUFBQyxDQUFBLEtBQUssQ0FBQyxHQUFQLENBQVcsSUFBQyxDQUFBLE9BQU8sQ0FBQyxVQUFwQixDQUErQixDQUFDLElBQWhDLENBQXFDLENBQUEsU0FBQSxLQUFBO2FBQUEsU0FBQyxJQUFEO2VBQVUsS0FBQyxDQUFBLEtBQUQsQ0FBTyxJQUFQO01BQVY7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQXJDO1dBR0EsQ0FBQSxDQUFFLFFBQUYsQ0FBVyxDQUFDLEVBQVosQ0FBZSxlQUFmLEVBQWdDLENBQUEsU0FBQSxLQUFBO2FBQUEsU0FBQTtlQUM5QixLQUFDLENBQUEsT0FBRCxDQUFTLE9BQVQsRUFBa0IsRUFBbEI7TUFEOEI7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQWhDO0VBUlU7Ozs7OztBQVlkLE1BQU0sQ0FBQyxNQUFQLEdBQWdCIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBSZWFkZXJcblxuICBjb25zdHJ1Y3RvcjogKEBvcHRpb25zID0ge30pLT5cblxuICAgIEBxdWVyeSAgICA9IG5ldyBAUXVlcnkoKVxuICAgIEBwYXJzZSAgICA9IG5ldyBAUGFyc2UoKVxuICAgIEBsYXlvdXQgICA9IG5ldyBATGF5b3V0KClcbiAgICBAYXNwZWN0ICAgPSBuZXcgQEFzcGVjdCgpXG4gICAgQHRlbXBsYXRlID0gbmV3IEBUZW1wbGF0ZSgpXG5cbiAgICBAcGFja2FnZSA9XG4gICAgICBhdHRyaWJ1dGVzOiBudWxsXG4gICAgICBndWlkZSAgICAgOiBudWxsXG4gICAgICBtYW5pZmVzdCAgOiBudWxsXG4gICAgICBtZXRhZGF0YSAgOiBudWxsXG4gICAgICBzcGluZSAgICAgOiBudWxsXG4gICAgICB0ZXh0ICAgICAgOiBudWxsXG5cbiAgICBAbG9jYXRpb24gPVxuICAgICAgYXNzZXRzIDogQG9wdGlvbnMuYXNzZXRzIG9yICcnXG4gICAgICB1cmwgICAgOiBcIiN7d2luZG93LmxvY2F0aW9uLm9yaWdpbn1cIi5yZXBsYWNlKC9cXC8kLywgJycpXG5cbiAgICBAbmF2ID1cbiAgICAgIGVsZW0gICAgICA6IG51bGxcbiAgICAgIHJlZ2V4cCAgICA6IG51bGxcbiAgICAgIHBhdGggICAgICA6IG51bGxcbiAgICAgIGF0dHJpYnV0ZSA6IG51bGxcblxuICAgIEBuYXZNYXAgICA9IG51bGxcbiAgICBAbmF2VXJsICAgPSBudWxsXG4gICAgQG5jeCAgICAgID0gbnVsbFxuICAgIEBuYXZSZSAgICA9IG51bGxcbiAgICBAaHRtbCAgICAgPSBbXVxuICAgIEBtZXRhZGF0YSA9IFtdXG5cbiAgICBAZWxlbSAgID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlYWRlcicpXG4gICAgQHBhZ2VjdCA9IG51bGxcblxuXG4gIGdldE5hdkRvY3VtZW50OiAodGhhdCktPlxuICAgIHJldHVybiAoa2V5LCB2YWwsIGl0ZW0pLT5cbiAgICAgIGlmIGtleSA9PSB0aGF0Lm5hdi5hdHRyaWJ1dGUgYW5kIHRoYXQubmF2LnJlZ2V4cC50ZXN0KHZhbClcbiAgICAgICAgdGhhdC5uYXYuZWxlbSA9IGl0ZW1cbiAgICAgICAgdGhhdC5uYXYucGF0aCA9IGl0ZW0uZ2V0QXR0cmlidXRlKCdocmVmJylcbiAgICAgICAgdGhhdC54bWwoKVxuXG4gIHJlbmRlclBhZ2U6ICh0aGF0LCBvcHRpb25zKS0+XG4gICAgcmV0dXJuICh1cmwsIHBhcmVudElkKSAtPlxuICAgICAgdGhhdC5xdWVyeS5odG1sKFwiI3t0aGF0LmxvY2F0aW9uLmFzc2V0c30vI3t1cmx9XCIpXG4gICAgICAgIC5kb25lIChkYXRhKS0+XG4gICAgICAgICAgZG9jID0gdGhhdC50ZW1wbGF0ZS5wYXJzZShkYXRhLCB0aGF0LmxvY2F0aW9uLmFzc2V0cylcbiAgICAgICAgICB0aGF0LmxheW91dC5yZW5kZXIoZG9jLCBwYXJlbnRJZClcbiAgICAgICAgICBpZiBub3QgdGhhdC5wYWdlY3QgLT0xIHRoZW4gdGhhdC50cmlnZ2VyKCdwYWdlc2xvYWRlZCcsIHt9KVxuXG4gIHhtbDogKCktPlxuICAgIGN1cnJ5ID0gQHJlbmRlclBhZ2UoQCwgQG9wdGlvbnMpXG4gICAgQHF1ZXJ5LnhtbChcIiN7QGxvY2F0aW9uLmFzc2V0c30vI3tAbmF2LnBhdGh9XCIpXG4gICAgICAuZG9uZSAoZGF0YSkgPT5cbiAgICAgICAgQG5jeCA9IEBwYXJzZS5uYXYoZGF0YSlcbiAgICAgICAgQG5hdk1hcCA9IEBwYXJzZS5tYXBOY3goQG5jeC5uYXZNYXAubmF2UG9pbnQpXG4gICAgICAgIEBsYXlvdXQuYnVpbGQoQG5hdk1hcCwgY3VycnkpXG5cbiAgYnVpbGQ6IChkYXRhKS0+XG4gICAgY3VycnkgPSBAZ2V0TmF2RG9jdW1lbnQoQClcbiAgICBAcGFnZWN0ID0gQHBhcnNlLnhtbChkYXRhLCBjdXJyeSkucGFja2FnZS5zcGluZS5pdGVtcmVmLmxlbmd0aFxuXG4gIG9uOiAoaGFuZGxlLCBjYWxsYmFjaykgLT5cbiAgICBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnQ3VzdG9tRXZlbnQnKVxuICAgIGV2dC5pbml0Q3VzdG9tRXZlbnQoaGFuZGxlLCB0cnVlLCBmYWxzZSwge30pXG4gICAgQGVsZW0uYWRkRXZlbnRMaXN0ZW5lcihoYW5kbGUsIGNhbGxiYWNrKVxuXG4gIHRyaWdnZXI6IChoYW5kbGUsIGRhdGEpIC0+XG4gICAgQGVsZW0uZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoaGFuZGxlLCBkYXRhKSlcblxuICBpbml0aWFsaXplOiAtPlxuICAgIHRva2VuID0gaWYgQG9wdGlvbnMudG9jIHRoZW4gJ25hdicgZWxzZSAnbmN4J1xuICAgIGF0dHIgPSBpZiBAb3B0aW9ucy50b2MgdGhlbiAncHJvcGVydGllcycgZWxzZSAnaWQnXG4gICAgQG5hdi5yZWdleHAgPSBuZXcgUmVnRXhwKFwiXiN7dG9rZW59JFwiLCAnaScpXG4gICAgQG5hdi5hdHRyaWJ1dGUgPSBhdHRyXG4gICAgQHF1ZXJ5LnhtbChAb3B0aW9ucy5wYWNrYWdlVXJsKS5kb25lIChkYXRhKSA9PiBAYnVpbGQoZGF0YSlcblxuICAgICMgc2VlIC92ZW5kb3IvalF1ZXJ5LVNjb3BlZC1DU1MtcGx1Z2luLW1hc3Rlci9qcXVlcnkuc2NvcGVkLmpzIzEwOVxuICAgICQoZG9jdW1lbnQpLm9uICdzdHlsZXM6c2NvcGVkJywgKCkgPT5cbiAgICAgIEB0cmlnZ2VyKCdyZWFkeScsIHt9KVxuXG5cbndpbmRvdy5SZWFkZXIgPSBSZWFkZXJcbiJdfQ==

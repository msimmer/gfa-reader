Reader.prototype.Events = (function() {
  function Events(options) {
    this.options = options != null ? options : {};
    this.defaults = {
      reader: '#reader-frame',
      docNav: '#doc-nav',
      navToggle: '[data-nav=contents]',
      chBack: '[data-nav=chBack]',
      chFwd: '[data-nav=chFwd]',
      pgBack: '[data-nav=pgBack]',
      pgFwd: '[data-nav=pgFwd]',
      speed: 400
    };
    this.isScrolling = false;
    this.triggeredScroll = false;
    this.minScroll = -12;
    this.maxScroll = 12;
    this.offset = 15;
    this.clickEvt = 'ontouchstart' in document.documentElement ? 'touchend' : 'click';
    this.elemPos = null;
    this.prevPos = null;
    this.currSpread = null;
    this.maxLen = null;
    this.columns = [];
    this.frameMap = [];
    this.settings = $.extend({}, this.options, this.defaults);
    this.frame = $(this.settings.reader);
    this.navbar = $(this.settings.docNav);
  }

  Events.prototype.preventDefault = function(e) {
    if (e && e.originalEvent) {
      e.preventDefault();
      return e.stopPropagation();
    }
  };

  Events.prototype.debounce = function(func, wait, immediate) {
    var timeout;
    timeout = void 0;
    return function() {
      var args, callNow, context, later;
      context = this;
      args = arguments;
      later = function() {
        timeout = null;
        if (!immediate) {
          return func.apply(context, args);
        }
      };
      callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) {
        return func.apply(context, args);
      }
    };
  };

  Events.prototype.setColGap = function() {
    return this.colGap = parseInt(this.frame.css('column-gap'), 10);
  };

  Events.prototype.setFrameWidth = function() {
    return this.frameWidth = this.frame.width();
  };

  Events.prototype.closestPos = function(num, arr) {
    var currIdx, currPos, diff, idx, item1, item2, j, k, len, len1, newdiff, ref, val;
    currPos = 0;
    currIdx = 0;
    diff = Math.abs(num - currPos);
    for (idx = j = 0, len = arr.length; j < len; idx = ++j) {
      item1 = arr[idx];
      ref = arr[idx];
      for (val = k = 0, len1 = ref.length; k < len1; val = ++k) {
        item2 = ref[val];
        newdiff = Math.abs(num - arr[idx][val]);
        if (newdiff < diff) {
          diff = newdiff;
          currPos = arr[idx][val];
          currIdx = idx;
        }
      }
    }
    return {
      idx: currIdx,
      pos: currPos
    };
  };

  Events.prototype.returnToPos = function() {
    var closest;
    closest = this.closestPos(this.frame.scrollLeft(), this.frameMap);
    this.prepareScroll();
    return this.animateScroll(closest.pos, null, closest.idx);
  };

  Events.prototype.mapColumns = function() {
    var screenW;
    this.frameMap = [];
    this.maxLen = 0;
    screenW = 0;
    this.columns.map((function(_this) {
      return function(cols, idx) {
        var i, j, panels, ref, result;
        result = [];
        _this.maxLen += cols;
        if (cols === 1) {
          result.push(screenW);
          screenW += _this.frameWidth / 2 + _this.colGap - _this.offset * 1.5;
        } else if (cols >= 2) {
          panels = Math.ceil(cols / 2);
          for (i = j = 1, ref = panels; 1 <= ref ? j <= ref : j >= ref; i = 1 <= ref ? ++j : --j) {
            result.push(screenW);
            screenW += _this.frameWidth + _this.colGap;
          }
        }
        return _this.frameMap[idx] = result;
      };
    })(this));
    return this.maxLen = Math.floor(this.maxLen / 2);
  };

  Events.prototype.setArticlePos = function() {
    var articles;
    articles = $('[data-article]');
    this.elemPos = 0;
    this.prevPos = 0;
    this.columns = [];
    return articles.each((function(_this) {
      return function(i, el) {
        var marker, pagePos, pageWidth, reader, readerOffset;
        el = $(el);
        el.append('<span class="mrk"/>');
        marker = $('.mrk');
        reader = {
          width: _this.frameWidth,
          left: _this.frame.offset().left,
          scrollPos: _this.frame.scrollLeft()
        };
        readerOffset = reader.left * 2;
        pageWidth = reader.width / 2 + reader.left;
        pagePos = (reader.scrollPos + marker.offset().left) - readerOffset + pageWidth;
        _this.elemPos = _this.prevPos || 0;
        _this.prevPos = pagePos < 0 ? 0 : pagePos;
        _this.columns.push(Math.ceil((_this.prevPos - _this.elemPos) / pageWidth));
        el.attr('data-offset-left', _this.elemPos);
        marker.remove();
        if (i === articles.length - 1) {
          return _this.mapColumns();
        }
      };
    })(this));
  };

  Events.prototype.bindElems = function() {
    $(document).on('keydown', (function(_this) {
      return function(e) {
        return _this.keyPress(e);
      };
    })(this));
    $(document).on(this.clickEvt, '.doc-link', (function(_this) {
      return function(e) {
        return _this.scrollChapter(e);
      };
    })(this));
    $(this.settings.navToggle).on(this.clickEvt, (function(_this) {
      return function(e) {
        return _this.toggleNav(e);
      };
    })(this));
    $(this.settings.chFwd).on(this.clickEvt, (function(_this) {
      return function(e) {
        return _this.scrollChapter(e, 1);
      };
    })(this));
    $(this.settings.chBack).on(this.clickEvt, (function(_this) {
      return function(e) {
        return _this.scrollChapter(e, -1);
      };
    })(this));
    $(this.settings.pgFwd).on(this.clickEvt, (function(_this) {
      return function(e) {
        return _this.scrollPage(e, 1);
      };
    })(this));
    return $(this.settings.pgBack).on(this.clickEvt, (function(_this) {
      return function(e) {
        return _this.scrollPage(e, -1);
      };
    })(this));
  };

  Events.prototype.prepareScroll = function(e) {
    this.preventDefault(e);
    if (this.isScrolling) {
      this.frame.stop(true, true);
    }
    return this.isScrolling = true;
  };

  Events.prototype.scrollPage = function(e, pos, callback) {
    var currLeft, dest, dist;
    this.prepareScroll(e);
    dist = this.frameWidth;
    currLeft = this.frame.scrollLeft();
    dest = (dist * pos) + currLeft + (this.colGap * pos);
    return this.animateScroll(dest, callback, pos);
  };

  Events.prototype.scrollChapter = function(e, callback) {
    var dest, target;
    this.prepareScroll(e);
    target = $("#" + ($(e.target).attr('data-link')));
    dest = target.attr('data-offset-left');
    return this.animateScroll(dest, callback);
  };

  Events.prototype.animateScroll = function(dest, callback, pos) {
    this.closeNav();
    return this.frame.stop(true, true).animate({
      scrollLeft: dest
    }, (function(_this) {
      return function() {
        var idx;
        _this.isScrolling = false;
        idx = parseInt("" + (_this.currSpread + pos), 10);
        _this.currSpread = idx < 0 ? 0 : idx > _this.maxLen ? _this.maxLen : idx;
        if (callback && typeof callback === 'function') {
          return callback();
        }
      };
    })(this));
  };

  Events.prototype.closeNav = function() {
    return this.navbar.removeClass('active');
  };

  Events.prototype.keyPress = function(e) {
    if (e && e.which) {
      switch (e.which) {
        case 27:
          return this.closeNav();
        case 37:
          return this.scrollPage(e, -1);
        case 39:
          return this.scrollPage(e, 1);
      }
    }
  };

  Events.prototype.toggleNav = function(e) {
    this.preventDefault(e);
    return this.navbar.toggleClass('active');
  };

  return Events;

})();

//# sourceMappingURL=data:application/json;base64,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QUFBLFNBQUEsS0FBQTthQUFBLFNBQUE7QUFDM0IsWUFBQTtRQUFBLEtBQUMsQ0FBQSxXQUFELEdBQWU7UUFDZixHQUFBLEdBQU0sUUFBQSxDQUFTLEVBQUEsR0FBRSxDQUFDLEtBQUMsQ0FBQSxVQUFELEdBQWMsR0FBZixDQUFYLEVBQWlDLEVBQWpDO1FBQ04sS0FBQyxDQUFBLFVBQUQsR0FBaUIsR0FBQSxHQUFNLENBQVQsR0FBZ0IsQ0FBaEIsR0FBMEIsR0FBQSxHQUFNLEtBQUMsQ0FBQSxNQUFWLEdBQXNCLEtBQUMsQ0FBQSxNQUF2QixHQUFtQztRQUN4RSxJQUFHLFFBQUEsSUFBYSxPQUFPLFFBQVAsS0FBbUIsVUFBbkM7aUJBQW1ELFFBQUEsQ0FBQSxFQUFuRDs7TUFKMkI7SUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBRi9CO0VBRlk7O21CQVVkLFFBQUEsR0FBUyxTQUFBO1dBQ1AsSUFBQyxDQUFBLE1BQU0sQ0FBQyxXQUFSLENBQW9CLFFBQXBCO0VBRE87O21CQUdULFFBQUEsR0FBUyxTQUFDLENBQUQ7SUFDUCxJQUFHLENBQUEsSUFBTSxDQUFDLENBQUMsS0FBWDtBQUNFLGNBQU8sQ0FBQyxDQUFDLEtBQVQ7QUFBQSxhQUNPLEVBRFA7aUJBQ2UsSUFBQyxDQUFBLFFBQUQsQ0FBQTtBQURmLGFBRU8sRUFGUDtpQkFFZSxJQUFDLENBQUEsVUFBRCxDQUFZLENBQVosRUFBZSxDQUFDLENBQWhCO0FBRmYsYUFHTyxFQUhQO2lCQUdlLElBQUMsQ0FBQSxVQUFELENBQVksQ0FBWixFQUFlLENBQWY7QUFIZixPQURGOztFQURPOzttQkFPVCxTQUFBLEdBQVcsU0FBQyxDQUFEO0lBQ1QsSUFBQyxDQUFBLGNBQUQsQ0FBZ0IsQ0FBaEI7V0FDQSxJQUFDLENBQUEsTUFBTSxDQUFDLFdBQVIsQ0FBb0IsUUFBcEI7RUFGUyIsImZpbGUiOiJldmVudHMuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBSZWFkZXI6OkV2ZW50c1xuXG4gIGNvbnN0cnVjdG9yOiAoQG9wdGlvbnMgPSB7fSkgLT5cblxuICAgICMgdGhlc2Ugc2hvdWxkIGJlIGZlZCBpbiBvbiBpbml0XG4gICAgQGRlZmF1bHRzID1cbiAgICAgIHJlYWRlciAgICA6ICcjcmVhZGVyLWZyYW1lJ1xuICAgICAgZG9jTmF2ICAgIDogJyNkb2MtbmF2J1xuICAgICAgbmF2VG9nZ2xlIDogJ1tkYXRhLW5hdj1jb250ZW50c10nXG4gICAgICBjaEJhY2sgICAgOiAnW2RhdGEtbmF2PWNoQmFja10nXG4gICAgICBjaEZ3ZCAgICAgOiAnW2RhdGEtbmF2PWNoRndkXSdcbiAgICAgIHBnQmFjayAgICA6ICdbZGF0YS1uYXY9cGdCYWNrXSdcbiAgICAgIHBnRndkICAgICA6ICdbZGF0YS1uYXY9cGdGd2RdJ1xuICAgICAgc3BlZWQgICAgIDogNDAwXG5cbiAgICBAaXNTY3JvbGxpbmcgICAgID0gZmFsc2VcbiAgICBAdHJpZ2dlcmVkU2Nyb2xsID0gZmFsc2VcbiAgICBAbWluU2Nyb2xsICAgICAgID0gLTEyXG4gICAgQG1heFNjcm9sbCAgICAgICA9IDEyXG4gICAgQG9mZnNldCAgICAgICAgICA9IDE1XG4gICAgQGNsaWNrRXZ0ICAgICAgICA9IGlmICdvbnRvdWNoc3RhcnQnIG9mIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB0aGVuICd0b3VjaGVuZCcgZWxzZSAnY2xpY2snXG4gICAgQGVsZW1Qb3MgICAgICAgICA9IG51bGxcbiAgICBAcHJldlBvcyAgICAgICAgID0gbnVsbFxuICAgIEBjdXJyU3ByZWFkICAgICAgPSBudWxsXG4gICAgQG1heExlbiAgICAgICAgICA9IG51bGxcblxuICAgIEBjb2x1bW5zICAgICAgICAgPSBbXVxuICAgIEBmcmFtZU1hcCAgICAgICAgPSBbXVxuXG4gICAgQHNldHRpbmdzICAgICAgICA9ICQuZXh0ZW5kKHt9LCBAb3B0aW9ucywgQGRlZmF1bHRzKVxuXG4gICAgQGZyYW1lICAgICAgICAgICA9ICQoQHNldHRpbmdzLnJlYWRlcilcbiAgICBAbmF2YmFyICAgICAgICAgID0gJChAc2V0dGluZ3MuZG9jTmF2KVxuXG4gIHByZXZlbnREZWZhdWx0OihlKS0+XG4gICAgaWYgZSBhbmQgZS5vcmlnaW5hbEV2ZW50XG4gICAgICBlLnByZXZlbnREZWZhdWx0KClcbiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKClcblxuICBkZWJvdW5jZTogKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgLT5cbiAgICB0aW1lb3V0ID0gdW5kZWZpbmVkXG4gICAgLT5cbiAgICAgIGNvbnRleHQgPSB0aGlzXG4gICAgICBhcmdzID0gYXJndW1lbnRzXG4gICAgICBsYXRlciA9IC0+XG4gICAgICAgIHRpbWVvdXQgPSBudWxsXG4gICAgICAgIGlmICFpbW1lZGlhdGVcbiAgICAgICAgICBmdW5jLmFwcGx5IGNvbnRleHQsIGFyZ3NcbiAgICAgIGNhbGxOb3cgPSBpbW1lZGlhdGUgYW5kICF0aW1lb3V0XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dClcbiAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KVxuICAgICAgaWYgY2FsbE5vd1xuICAgICAgICBmdW5jLmFwcGx5IGNvbnRleHQsIGFyZ3NcblxuICBzZXRDb2xHYXA6KCktPlxuICAgIEBjb2xHYXAgPSBwYXJzZUludChAZnJhbWUuY3NzKCdjb2x1bW4tZ2FwJyksIDEwKVxuXG4gIHNldEZyYW1lV2lkdGg6KCktPlxuICAgIEBmcmFtZVdpZHRoID0gQGZyYW1lLndpZHRoKClcblxuICBjbG9zZXN0UG9zOiAobnVtLCBhcnIpIC0+XG4gICAgY3VyclBvcyA9IDBcbiAgICBjdXJySWR4ID0gMFxuICAgIGRpZmYgPSBNYXRoLmFicyhudW0gLSBjdXJyUG9zKVxuICAgIGZvciBpdGVtMSwgaWR4IGluIGFyclxuICAgICAgZm9yIGl0ZW0yLCB2YWwgaW4gYXJyW2lkeF1cbiAgICAgICAgbmV3ZGlmZiA9IE1hdGguYWJzKG51bSAtIGFycltpZHhdW3ZhbF0pXG4gICAgICAgIGlmIChuZXdkaWZmIDwgZGlmZilcbiAgICAgICAgICBkaWZmID0gbmV3ZGlmZlxuICAgICAgICAgIGN1cnJQb3MgPSBhcnJbaWR4XVt2YWxdXG4gICAgICAgICAgY3VycklkeCA9IGlkeFxuICAgIHJldHVybiB7aWR4OiBjdXJySWR4LCBwb3M6IGN1cnJQb3N9XG5cbiAgcmV0dXJuVG9Qb3M6KCktPlxuICAgIGNsb3Nlc3QgPSBAY2xvc2VzdFBvcyhAZnJhbWUuc2Nyb2xsTGVmdCgpLCBAZnJhbWVNYXApXG4gICAgQHByZXBhcmVTY3JvbGwoKVxuICAgIEBhbmltYXRlU2Nyb2xsKGNsb3Nlc3QucG9zLCBudWxsLCBjbG9zZXN0LmlkeClcblxuICBtYXBDb2x1bW5zOigpLT5cbiAgICBAZnJhbWVNYXAgPSBbXVxuICAgIEBtYXhMZW4gPSAwXG4gICAgc2NyZWVuVyA9IDBcbiAgICBAY29sdW1ucy5tYXAgKGNvbHMsIGlkeCk9PlxuXG4gICAgICByZXN1bHQgPSBbXVxuICAgICAgQG1heExlbiArPSBjb2xzXG5cbiAgICAgIGlmIGNvbHMgPT0gMVxuICAgICAgICByZXN1bHQucHVzaChzY3JlZW5XKVxuICAgICAgICBzY3JlZW5XICs9IEBmcmFtZVdpZHRoIC8gMiArIEBjb2xHYXAgLSBAb2Zmc2V0ICogMS41XG5cbiAgICAgIGVsc2UgaWYgY29scyA+PSAyXG4gICAgICAgIHBhbmVscyA9IE1hdGguY2VpbChjb2xzLzIpXG4gICAgICAgIGZvciBpIGluIFsxLi5wYW5lbHNdXG4gICAgICAgICAgcmVzdWx0LnB1c2goc2NyZWVuVylcbiAgICAgICAgICBzY3JlZW5XICs9IEBmcmFtZVdpZHRoICsgQGNvbEdhcFxuXG4gICAgICBAZnJhbWVNYXBbaWR4XSA9IHJlc3VsdFxuICAgIEBtYXhMZW4gPSBNYXRoLmZsb29yKEBtYXhMZW4vMilcblxuICBzZXRBcnRpY2xlUG9zOigpLT5cbiAgICBhcnRpY2xlcyA9ICQoJ1tkYXRhLWFydGljbGVdJylcbiAgICBAZWxlbVBvcyA9IDBcbiAgICBAcHJldlBvcyA9IDBcbiAgICBAY29sdW1ucyA9IFtdXG4gICAgYXJ0aWNsZXMuZWFjaCAoaSwgZWwpID0+XG4gICAgICBlbCA9ICQoZWwpXG4gICAgICBlbC5hcHBlbmQoJzxzcGFuIGNsYXNzPVwibXJrXCIvPicpXG4gICAgICBtYXJrZXIgPSAkKCcubXJrJylcblxuICAgICAgcmVhZGVyID1cbiAgICAgICAgd2lkdGg6IEBmcmFtZVdpZHRoXG4gICAgICAgIGxlZnQ6IEBmcmFtZS5vZmZzZXQoKS5sZWZ0XG4gICAgICAgIHNjcm9sbFBvczogQGZyYW1lLnNjcm9sbExlZnQoKVxuXG4gICAgICAjIGlubmVyIGRpbXMgb2YgcmVhZGVyIGVsZW1lbnRcbiAgICAgIHJlYWRlck9mZnNldCA9IHJlYWRlci5sZWZ0ICogMlxuICAgICAgIyBzaW5nbGUgcGFnZSB3aWR0aCwgaW5jbHVkaW5nIGlubmVyIHBhZ2UgcGFkZGluZ1xuICAgICAgcGFnZVdpZHRoID0gcmVhZGVyLndpZHRoIC8gMiArIHJlYWRlci5sZWZ0XG4gICAgICAjIG1hcmtlciByZWxhdGVzIHRvIHByZXYuIHBhZ2UncyBiZWdpbm5pbmdcbiAgICAgIHBhZ2VQb3MgPSAocmVhZGVyLnNjcm9sbFBvcyArIG1hcmtlci5vZmZzZXQoKS5sZWZ0KSAtIHJlYWRlck9mZnNldCArIHBhZ2VXaWR0aFxuXG4gICAgICBAZWxlbVBvcyA9IEBwcmV2UG9zIG9yIDBcbiAgICAgIEBwcmV2UG9zID0gaWYgcGFnZVBvcyA8IDAgdGhlbiAwIGVsc2UgcGFnZVBvc1xuXG4gICAgICBAY29sdW1ucy5wdXNoKE1hdGguY2VpbCgoQHByZXZQb3MgLSBAZWxlbVBvcykgLyBwYWdlV2lkdGgpKVxuXG4gICAgICBlbC5hdHRyKCdkYXRhLW9mZnNldC1sZWZ0JywgQGVsZW1Qb3MpXG4gICAgICBtYXJrZXIucmVtb3ZlKClcblxuICAgICAgaWYgaSA9PSBhcnRpY2xlcy5sZW5ndGggLSAxIHRoZW4gQG1hcENvbHVtbnMoKVxuXG4gIGJpbmRFbGVtczooKS0+XG4gICAgJChkb2N1bWVudCkub24gJ2tleWRvd24nLCAoZSkgICAgICAgICAgICAgID0+IEBrZXlQcmVzcyhlKVxuICAgICQoZG9jdW1lbnQpLm9uIEBjbGlja0V2dCwgJy5kb2MtbGluaycsIChlKSA9PiBAc2Nyb2xsQ2hhcHRlcihlKVxuICAgICQoQHNldHRpbmdzLm5hdlRvZ2dsZSkub24gQGNsaWNrRXZ0LCAoZSkgICA9PiBAdG9nZ2xlTmF2KGUpXG4gICAgJChAc2V0dGluZ3MuY2hGd2QpLm9uIEBjbGlja0V2dCwgKGUpICAgICAgID0+IEBzY3JvbGxDaGFwdGVyKGUsIDEpXG4gICAgJChAc2V0dGluZ3MuY2hCYWNrKS5vbiBAY2xpY2tFdnQsIChlKSAgICAgID0+IEBzY3JvbGxDaGFwdGVyKGUsIC0xKVxuICAgICQoQHNldHRpbmdzLnBnRndkKS5vbiBAY2xpY2tFdnQsIChlKSAgICAgICA9PiBAc2Nyb2xsUGFnZShlLCAxKVxuICAgICQoQHNldHRpbmdzLnBnQmFjaykub24gQGNsaWNrRXZ0LCAoZSkgICAgICA9PiBAc2Nyb2xsUGFnZShlLCAtMSlcblxuICBwcmVwYXJlU2Nyb2xsOihlKS0+XG4gICAgQHByZXZlbnREZWZhdWx0KGUpXG4gICAgaWYgQGlzU2Nyb2xsaW5nIHRoZW4gQGZyYW1lLnN0b3AodHJ1ZSx0cnVlKVxuICAgIEBpc1Njcm9sbGluZyA9IHRydWVcblxuICBzY3JvbGxQYWdlOihlLCBwb3MsIGNhbGxiYWNrKS0+XG4gICAgQHByZXBhcmVTY3JvbGwoZSlcbiAgICBkaXN0ID0gQGZyYW1lV2lkdGhcbiAgICBjdXJyTGVmdCA9IEBmcmFtZS5zY3JvbGxMZWZ0KClcbiAgICBkZXN0ID0gIChkaXN0ICogcG9zKSArIGN1cnJMZWZ0ICsgKEBjb2xHYXAgKiBwb3MpXG4gICAgQGFuaW1hdGVTY3JvbGwoZGVzdCwgY2FsbGJhY2ssIHBvcylcblxuICBzY3JvbGxDaGFwdGVyOihlLCBjYWxsYmFjayktPlxuICAgIEBwcmVwYXJlU2Nyb2xsKGUpXG4gICAgdGFyZ2V0ID0gJChcIiMjeyQoZS50YXJnZXQpLmF0dHIoJ2RhdGEtbGluaycpfVwiKVxuICAgIGRlc3QgPSB0YXJnZXQuYXR0cignZGF0YS1vZmZzZXQtbGVmdCcpXG4gICAgQGFuaW1hdGVTY3JvbGwoZGVzdCwgY2FsbGJhY2spXG5cbiAgYW5pbWF0ZVNjcm9sbDooZGVzdCwgY2FsbGJhY2ssIHBvcykgLT5cbiAgICBAY2xvc2VOYXYoKVxuICAgIEBmcmFtZVxuICAgICAgLnN0b3AodHJ1ZSwgdHJ1ZSlcbiAgICAgIC5hbmltYXRlIHtzY3JvbGxMZWZ0OiBkZXN0fSwgKCkgPT5cbiAgICAgICAgQGlzU2Nyb2xsaW5nID0gZmFsc2VcbiAgICAgICAgaWR4ID0gcGFyc2VJbnQoXCIje0BjdXJyU3ByZWFkICsgcG9zfVwiLCAxMClcbiAgICAgICAgQGN1cnJTcHJlYWQgPSBpZiBpZHggPCAwIHRoZW4gMCBlbHNlIGlmIGlkeCA+IEBtYXhMZW4gdGhlbiBAbWF4TGVuIGVsc2UgaWR4XG4gICAgICAgIGlmIGNhbGxiYWNrIGFuZCB0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJyB0aGVuIGNhbGxiYWNrKClcblxuICBjbG9zZU5hdjooKS0+XG4gICAgQG5hdmJhci5yZW1vdmVDbGFzcygnYWN0aXZlJylcblxuICBrZXlQcmVzczooZSkgLT5cbiAgICBpZiBlIGFuZCBlLndoaWNoXG4gICAgICBzd2l0Y2ggZS53aGljaFxuICAgICAgICB3aGVuIDI3IHRoZW4gQGNsb3NlTmF2KClcbiAgICAgICAgd2hlbiAzNyB0aGVuIEBzY3JvbGxQYWdlKGUsIC0xKVxuICAgICAgICB3aGVuIDM5IHRoZW4gQHNjcm9sbFBhZ2UoZSwgMSlcblxuICB0b2dnbGVOYXY6IChlKS0+XG4gICAgQHByZXZlbnREZWZhdWx0KGUpXG4gICAgQG5hdmJhci50b2dnbGVDbGFzcygnYWN0aXZlJylcbiJdfQ==
